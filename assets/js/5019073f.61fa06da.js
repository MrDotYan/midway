"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[8651],{3905:(e,n,t)=>{t.d(n,{Zo:()=>m,kt:()=>k});var r=t(67294);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function l(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function p(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?l(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,r,a=function(e,n){if(null==e)return{};var t,r,a={},l=Object.keys(e);for(r=0;r<l.length;r++)t=l[r],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(r=0;r<l.length;r++)t=l[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var i=r.createContext({}),s=function(e){var n=r.useContext(i),t=n;return e&&(t="function"==typeof e?e(n):p(p({},n),e)),t},m=function(e){var n=s(e.components);return r.createElement(i.Provider,{value:n},e.children)},d="mdxType",c={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},u=r.forwardRef((function(e,n){var t=e.components,a=e.mdxType,l=e.originalType,i=e.parentName,m=o(e,["components","mdxType","originalType","parentName"]),d=s(t),u=a,k=d["".concat(i,".").concat(u)]||d[u]||c[u]||l;return t?r.createElement(k,p(p({ref:n},m),{},{components:t})):r.createElement(k,p({ref:n},m))}));function k(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var l=t.length,p=new Array(l);p[0]=u;var o={};for(var i in n)hasOwnProperty.call(n,i)&&(o[i]=n[i]);o.originalType=e,o[d]="string"==typeof e?e:a,p[1]=o;for(var s=2;s<l;s++)p[s]=t[s];return r.createElement.apply(null,p)}return r.createElement.apply(null,t)}u.displayName="MDXCreateElement"},99954:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>i,contentTitle:()=>p,default:()=>c,frontMatter:()=>l,metadata:()=>o,toc:()=>s});var r=t(87462),a=(t(67294),t(3905));const l={},p="gRPC",o={unversionedId:"extensions/grpc",id:"extensions/grpc",title:"gRPC",description:"gRPC \u662f\u4e00\u4e2a\u9ad8\u6027\u80fd\u3001\u901a\u7528\u7684\u5f00\u6e90 RPC \u6846\u67b6\uff0c\u5176\u7531 Google \u4e3b\u8981\u9762\u5411\u79fb\u52a8\u5e94\u7528\u5f00\u53d1\u5e76\u57fa\u4e8e HTTP/2 \u534f\u8bae\u6807\u51c6\u800c\u8bbe\u8ba1\uff0c\u57fa\u4e8e ProtoBuf(Protocol Buffers) \u5e8f\u5217\u5316\u534f\u8bae\u5f00\u53d1\uff0c\u4e14\u652f\u6301\u4f17\u591a\u5f00\u53d1\u8bed\u8a00\u3002",source:"@site/docs/extensions/grpc.md",sourceDirName:"extensions",slug:"/extensions/grpc",permalink:"/docs/extensions/grpc",draft:!1,editUrl:"https://github.com/midwayjs/midway/tree/main/site/docs/extensions/grpc.md",tags:[],version:"current",frontMatter:{},sidebar:"component",previous:{title:"MikroORM",permalink:"/docs/extensions/mikro"},next:{title:"Consul",permalink:"/docs/extensions/consul"}},i={},s=[{value:"\u5b89\u88c5\u4f9d\u8d56",id:"\u5b89\u88c5\u4f9d\u8d56",level:2},{value:"\u5f00\u542f\u7ec4\u4ef6",id:"\u5f00\u542f\u7ec4\u4ef6",level:2},{value:"\u76ee\u5f55\u7ed3\u6784",id:"\u76ee\u5f55\u7ed3\u6784",level:2},{value:"\u5b9a\u4e49\u670d\u52a1\u63a5\u53e3",id:"\u5b9a\u4e49\u670d\u52a1\u63a5\u53e3",level:2},{value:"\u7f16\u5199 proto \u6587\u4ef6",id:"\u7f16\u5199-proto-\u6587\u4ef6",level:3},{value:"\u751f\u6210\u4ee3\u7801\u5b9a\u4e49",id:"\u751f\u6210\u4ee3\u7801\u5b9a\u4e49",level:3},{value:"\u63d0\u4f9b gRPC \u670d\u52a1\uff08Provider\uff09",id:"\u63d0\u4f9b-grpc-\u670d\u52a1provider",level:2},{value:"\u7f16\u5199\u670d\u52a1\u63d0\u4f9b\u65b9\uff08Provider\uff09",id:"\u7f16\u5199\u670d\u52a1\u63d0\u4f9b\u65b9provider",level:3},{value:"\u914d\u7f6e\u670d\u52a1",id:"\u914d\u7f6e\u670d\u52a1",level:3},{value:"\u63d0\u4f9b\u5b89\u5168\u8bc1\u4e66",id:"\u63d0\u4f9b\u5b89\u5168\u8bc1\u4e66",level:3},{value:"\u7f16\u5199\u5355\u5143\u6d4b\u8bd5",id:"\u7f16\u5199\u5355\u5143\u6d4b\u8bd5",level:3},{value:"\u8c03\u7528 gRPC \u670d\u52a1\uff08Consumer\uff09",id:"\u8c03\u7528-grpc-\u670d\u52a1consumer",level:2},{value:"\u8c03\u7528\u914d\u7f6e",id:"\u8c03\u7528\u914d\u7f6e",level:3},{value:"\u4ee3\u7801\u8c03\u7528",id:"\u4ee3\u7801\u8c03\u7528",level:3},{value:"\u6d41\u5f0f\u670d\u52a1",id:"\u6d41\u5f0f\u670d\u52a1",level:2},{value:"\u6d41\u5f0f proto \u6587\u4ef6",id:"\u6d41\u5f0f-proto-\u6587\u4ef6",level:3},{value:"\u670d\u52a1\u7aef\u63a8\u9001",id:"\u670d\u52a1\u7aef\u63a8\u9001",level:3},{value:"\u5ba2\u6237\u7aef\u63a8\u9001",id:"\u5ba2\u6237\u7aef\u63a8\u9001",level:3},{value:"\u53cc\u5411\u6d41",id:"\u53cc\u5411\u6d41",level:3},{value:"\u5143\u6570\u636e\uff08Metadata\uff09",id:"\u5143\u6570\u636emetadata",level:2},{value:"\u8d85\u65f6\u5904\u7406",id:"\u8d85\u65f6\u5904\u7406",level:2}],m={toc:s},d="wrapper";function c(e){let{components:n,...t}=e;return(0,a.kt)(d,(0,r.Z)({},m,t,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"grpc"},"gRPC"),(0,a.kt)("p",null,"gRPC \u662f\u4e00\u4e2a\u9ad8\u6027\u80fd\u3001\u901a\u7528\u7684\u5f00\u6e90 RPC \u6846\u67b6\uff0c\u5176\u7531 Google \u4e3b\u8981\u9762\u5411\u79fb\u52a8\u5e94\u7528\u5f00\u53d1\u5e76\u57fa\u4e8e HTTP/2 \u534f\u8bae\u6807\u51c6\u800c\u8bbe\u8ba1\uff0c\u57fa\u4e8e ProtoBuf(Protocol Buffers) \u5e8f\u5217\u5316\u534f\u8bae\u5f00\u53d1\uff0c\u4e14\u652f\u6301\u4f17\u591a\u5f00\u53d1\u8bed\u8a00\u3002"),(0,a.kt)("p",null,"\u672c\u7bc7\u5185\u5bb9\u6f14\u793a\u4e86\u5982\u4f55\u5728 Midway \u4f53\u7cfb\u4e0b\uff0c\u63d0\u4f9b gRPC \u670d\u52a1\uff0c\u4ee5\u53ca\u8c03\u7528 gRPC \u670d\u52a1\u7684\u65b9\u6cd5\u3002"),(0,a.kt)("p",null,"Midway \u5f53\u524d\u91c7\u7528\u4e86\u6700\u65b0\u7684 gRPC \u5b98\u65b9\u63a8\u8350\u7684 ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/grpc/grpc-node/tree/master/packages/grpc-js"},"@grpc/grpc-js")," \u8fdb\u884c\u5f00\u53d1\uff0c\u5e76\u63d0\u4f9b\u4e86\u4e00\u4e9b\u5de5\u5177\u5305\uff0c\u7528\u4e8e\u5feb\u901f\u53d1\u5e03\u670d\u52a1\u548c\u8c03\u7528\u670d\u52a1\u3002"),(0,a.kt)("p",null,"\u6211\u4eec\u4f7f\u7528\u7684\u6a21\u5757\u4e3a ",(0,a.kt)("inlineCode",{parentName:"p"},"@midwayjs/grpc")," \uff0c\u65e2\u53ef\u4ee5\u72ec\u7acb\u53d1\u5e03\u670d\u52a1\uff0c\u53c8\u53ef\u4ee5\u63a5\u5165\u5176\u5b83\u6846\u67b6\u8c03\u7528 gRPC \u670d\u52a1\u3002"),(0,a.kt)("p",null,"\u76f8\u5173\u4fe1\u606f\uff1a"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"\u63d0\u4f9b\u670d\u52a1")),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"\u63cf\u8ff0"),(0,a.kt)("th",{parentName:"tr",align:null}))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u53ef\u7528\u4e8e\u6807\u51c6\u9879\u76ee"),(0,a.kt)("td",{parentName:"tr",align:null},"\u2705")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u53ef\u7528\u4e8e Serverless"),(0,a.kt)("td",{parentName:"tr",align:null},"\u274c")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u53ef\u7528\u4e8e\u4e00\u4f53\u5316"),(0,a.kt)("td",{parentName:"tr",align:null},"\u2705")))),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"\u8c03\u7528\u670d\u52a1")),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"\u63cf\u8ff0"),(0,a.kt)("th",{parentName:"tr",align:null}))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u53ef\u7528\u4e8e\u6807\u51c6\u9879\u76ee"),(0,a.kt)("td",{parentName:"tr",align:null},"\u2705")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u53ef\u7528\u4e8e Serverless"),(0,a.kt)("td",{parentName:"tr",align:null},"\u2705")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u53ef\u7528\u4e8e\u4e00\u4f53\u5316"),(0,a.kt)("td",{parentName:"tr",align:null},"\u2705")))),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"\u5176\u4ed6")),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"\u63cf\u8ff0"),(0,a.kt)("th",{parentName:"tr",align:null}))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u53ef\u4f5c\u4e3a\u4e3b\u6846\u67b6\u72ec\u7acb\u4f7f\u7528"),(0,a.kt)("td",{parentName:"tr",align:null},"\u2705")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"\u53ef\u72ec\u7acb\u6dfb\u52a0\u4e2d\u95f4\u4ef6"),(0,a.kt)("td",{parentName:"tr",align:null},"\u2705")))),(0,a.kt)("h2",{id:"\u5b89\u88c5\u4f9d\u8d56"},"\u5b89\u88c5\u4f9d\u8d56"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"$ npm i @midwayjs/grpc@3 --save\n$ npm i @midwayjs/grpc-helper --save-dev\n")),(0,a.kt)("p",null,"\u6216\u8005\u5728 ",(0,a.kt)("inlineCode",{parentName:"p"},"package.json")," \u4e2d\u589e\u52a0\u5982\u4e0b\u4f9d\u8d56\u540e\uff0c\u91cd\u65b0\u5b89\u88c5\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "dependencies": {\n    "@midwayjs/grpc": "^3.0.0",\n    // ...\n  },\n  "devDependencies": {\n    "@midwayjs/grpc-helper": "^1.0.0",\n    // ...\n  }\n}\n')),(0,a.kt)("h2",{id:"\u5f00\u542f\u7ec4\u4ef6"},"\u5f00\u542f\u7ec4\u4ef6"),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"\u4e0d\u7ba1\u662f\u63d0\u4f9b\u670d\u52a1\u8fd8\u662f\u8c03\u7528\u670d\u52a1\uff0c\u90fd\u9700\u8981\u5f00\u542f\u7ec4\u4ef6\u3002")),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"@midwayjs/grpc")," \u53ef\u4ee5\u4f5c\u4e3a\u72ec\u7acb\u4e3b\u6846\u67b6\u4f7f\u7528\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/configuration.ts\nimport { Configuration } from '@midwayjs/core';\nimport * as grpc from '@midwayjs/grpc';\n\n@Configuration({\n  imports: [grpc],\n  // ...\n})\nexport class MainConfiguration {\n  async onReady() {\n        // ...\n  }\n}\n\n")),(0,a.kt)("p",null,"\u4e5f\u53ef\u4ee5\u9644\u52a0\u5728\u5176\u4ed6\u7684\u4e3b\u6846\u67b6\u4e0b\uff0c\u6bd4\u5982 ",(0,a.kt)("inlineCode",{parentName:"p"},"@midwayjs/koa")," \u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/configuration.ts\nimport { Configuration } from '@midwayjs/core';\nimport * as koa from '@midwayjs/koa';\nimport * as grpc from '@midwayjs/grpc';\n\n@Configuration({\n  imports: [koa, grpc],\n  // ...\n})\nexport class MainConfiguration {\n  async onReady() {\n        // ...\n  }\n}\n\n")),(0,a.kt)("h2",{id:"\u76ee\u5f55\u7ed3\u6784"},"\u76ee\u5f55\u7ed3\u6784"),(0,a.kt)("p",null,"\u5927\u81f4\u7684\u76ee\u5f55\u7ed3\u6784\u5982\u4e0b\uff0c",(0,a.kt)("inlineCode",{parentName:"p"},"src/provider")," \u662f\u63d0\u4f9b gRPC \u670d\u52a1\u7684\u76ee\u5f55\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},".\n\u251c\u2500\u2500 package.json\n\u251c\u2500\u2500 proto                         ## proto \u5b9a\u4e49\u6587\u4ef6\n\u2502   \u2514\u2500\u2500 helloworld.proto\n\u251c\u2500\u2500 src\n\u2502   \u251c\u2500\u2500 configuration.ts          ## \u5165\u53e3\u914d\u7f6e\u6587\u4ef6\n\u2502   \u251c\u2500\u2500 interface.ts\n\u2502   \u2514\u2500\u2500 provider                  ## gRPC \u63d0\u4f9b\u670d\u52a1\u7684\u6587\u4ef6\n\u2502       \u2514\u2500\u2500 greeter.ts\n\u251c\u2500\u2500 test\n\u251c\u2500\u2500 bootstrap.js                  ## \u670d\u52a1\u542f\u52a8\u5165\u53e3\n\u2514\u2500\u2500 tsconfig.json\n")),(0,a.kt)("h2",{id:"\u5b9a\u4e49\u670d\u52a1\u63a5\u53e3"},"\u5b9a\u4e49\u670d\u52a1\u63a5\u53e3"),(0,a.kt)("p",null,"\u5728\u5fae\u670d\u52a1\u4e2d\uff0c\u5b9a\u4e49\u4e00\u4e2a\u670d\u52a1\u9700\u8981\u7279\u5b9a\u7684\u63a5\u53e3\u5b9a\u4e49\u8bed\u8a00\uff08IDL\uff09\u6765\u5b8c\u6210\uff0c\u5728 gRPC\u4e2d \u9ed8\u8ba4\u4f7f\u7528 Protocol Buffers  \u4f5c\u4e3a\u5e8f\u5217\u5316\u534f\u8bae\u3002"),(0,a.kt)("p",null,"\u5e8f\u5217\u5316\u534f\u8bae\u72ec\u7acb\u4e8e\u8bed\u8a00\u548c\u5e73\u53f0\uff0c\u63d0\u4f9b\u4e86\u591a\u79cd\u8bed\u8a00\u7684\u5b9e\u73b0\uff0cJava\uff0cC++\uff0cGo \u7b49\u7b49,\u6bcf\u4e00\u79cd\u5b9e\u73b0\u90fd\u5305\u542b\u4e86\u76f8\u5e94\u8bed\u8a00\u7684\u7f16\u8bd1\u5668\u548c\u5e93\u6587\u4ef6\u3002\u6240\u4ee5 gRPC \u662f\u4e00\u4e2a\u63d0\u4f9b\u548c\u8c03\u7528\u90fd\u53ef\u4ee5\u8de8\u8bed\u8a00\u7684\u670d\u52a1\u6846\u67b6\u3002"),(0,a.kt)("p",null,"\u4e00\u4e2agRPC\u670d\u52a1\u7684\u5927\u4f53\u67b6\u6784\u53ef\u4ee5\u7528\u5b98\u7f51\u4e0a\u7684\u4e00\u5e45\u56fe\u8868\u793a\u3002"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://img.alicdn.com/imgextra/i3/O1CN01kpIyg51k8i5DtcGpZ_!!6000000004639-2-tps-621-445.png",alt:null})),(0,a.kt)("p",null,"Protocol Buffers  \u534f\u8bae\u7684\u6587\u4ef6\uff0c\u9ed8\u8ba4\u7684\u540e\u7f00\u4e3a ",(0,a.kt)("inlineCode",{parentName:"p"},".proto")," \u3002.proto\u540e\u7f00\u7684IDL\u6587\u4ef6,\u5e76\u901a\u8fc7\u5176\u7f16\u8bd1\u5668\u751f\u6210\u7279\u5b9a\u8bed\u8a00\u7684\u6570\u636e\u7ed3\u6784\u3001\u670d\u52a1\u7aef\u63a5\u53e3\u548c\u5ba2\u6237\u7aefStub\u4ee3\u7801\u3002"),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"\u7531\u4e8e proto \u6587\u4ef6\u53ef\u4ee5\u8de8\u8bed\u8a00\u4f7f\u7528\uff0c\u4e3a\u4e86\u65b9\u4fbf\u5171\u4eab\uff0c\u6211\u4eec\u4e00\u822c\u5c06 proto \u6587\u4ef6\u653e\u5728 src \u76ee\u5f55\u5916\u4fa7\uff0c\u65b9\u4fbf\u5176\u4ed6\u5de5\u5177\u590d\u5236\u5206\u53d1\u3002")),(0,a.kt)("p",null,"\u4e0b\u9762\u662f\u4e00\u4e2a\u57fa\u7840\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"proto/helloworld.proto"),"  \u6587\u4ef6\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-protobuf"},'syntax = "proto3";\n\npackage helloworld;\n\nservice Greeter {\n  // Sends a greeting\n  rpc SayHello (HelloRequest) returns (HelloReply) {}\n}\n\nmessage HelloRequest {\n  string name = 1;\n}\n\nmessage HelloReply {\n  string message = 1;\n}\n\n')),(0,a.kt)("p",null,"proto3 \u8868\u793a\u7684\u662f\u7b2c\u4e09\u7248\u7684 protobuf \u534f\u8bae\uff0c\u662f gRPC \u76ee\u524d\u63a8\u8350\u7684\u7248\u672c\uff0c\u201c\u8bed\u6cd5\u7b80\u5355\uff0c\u529f\u80fd\u66f4\u5168\u201d\u3002"),(0,a.kt)("p",null,"\u6211\u4eec\u53ef\u4ee5\u7528 ",(0,a.kt)("inlineCode",{parentName:"p"},"service")," \u683c\u5f0f\uff0c\u5b9a\u4e49\u670d\u52a1\u4f53\uff0c\u5176\u4e2d\u53ef\u4ee5\u5305\u542b\u65b9\u6cd5\u3002\u540c\u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u66f4\u52a0\u7ec6\u81f4\u7684\u901a\u8fc7 ",(0,a.kt)("inlineCode",{parentName:"p"},"message")," \u63cf\u8ff0\u670d\u52a1\u5177\u4f53\u7684\u8bf7\u6c42\u53c2\u6570\u548c\u54cd\u5e94\u53c2\u6570\u3002"),(0,a.kt)("p",null,"\u6211\u4eec\u53ef\u4ee5\u4ece ",(0,a.kt)("a",{parentName:"p",href:"https://developers.google.com/protocol-buffers/docs/overview#simple"},"Google \u7684\u5b98\u7f51\u6587\u6863")," \u4e2d\u67e5\u770b\u66f4\u591a\u7ec6\u8282\u3002"),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"\u5927\u5bb6\u4f1a\u770b\u5230\uff0c\u8fd9\u548c Java \u4e2d\u7684 Class \u975e\u5e38\u76f8\u50cf\uff0c\u6bcf\u4e2a\u7ed3\u6784\u5c31\u76f8\u5f53\u4e8e Java \u4e2d\u7684\u4e00\u4e2a\u7c7b\u3002")),(0,a.kt)("h3",{id:"\u7f16\u5199-proto-\u6587\u4ef6"},"\u7f16\u5199 proto \u6587\u4ef6"),(0,a.kt)("p",null,"\u73b0\u5728\u6211\u4eec\u518d\u6765\u770b\u4e4b\u524d\u7684\u670d\u52a1\uff0c\u662f\u4e0d\u662f\u5c31\u5f88\u597d\u7406\u89e3\u4e86\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-protobuf"},'syntax = "proto3";\n\npackage helloworld;\n\n// \u670d\u52a1\u7684\u5b9a\u4e49\nservice Greeter {\n  // Sends a greeting\n  rpc SayHello (HelloRequest) returns (HelloReply) {}\n}\n\n// \u670d\u52a1\u7684\u8bf7\u6c42\u53c2\u6570\nmessage HelloRequest {\n  string name = 1;\n}\n\n// \u670d\u52a1\u7684\u54cd\u5e94\u53c2\u6570\nmessage HelloReply {\n  string message = 1;\n}\n\n')),(0,a.kt)("p",null,"\u6211\u4eec\u5b9a\u4e49\u4e86\u4e00\u4e2a\u540d\u4e3a ",(0,a.kt)("inlineCode",{parentName:"p"},"Greeter")," \u7684\u670d\u52a1\uff0c\u5305\u542b\u4e00\u4e2a ",(0,a.kt)("inlineCode",{parentName:"p"},"HelloRequest")," \u7ed3\u6784\u7684\u8bf7\u6c42\u4f53\uff0c\u4ee5\u53ca\u8fd4\u56de ",(0,a.kt)("inlineCode",{parentName:"p"},"HelloReply")," \u7ed3\u6784\u7684\u54cd\u5e94\u4f53\u3002"),(0,a.kt)("p",null,"\u63a5\u4e0b\u53bb\uff0c\u6211\u4eec\u5c06\u5bf9\u8fd9\u4e2a\u670d\u52a1\u7ed9\u5927\u5bb6\u505a\u6f14\u793a\u3002"),(0,a.kt)("h3",{id:"\u751f\u6210\u4ee3\u7801\u5b9a\u4e49"},"\u751f\u6210\u4ee3\u7801\u5b9a\u4e49"),(0,a.kt)("p",null,"\u4f20\u7edf\u7684 gRPC \u6846\u67b6\uff0c\u9700\u8981\u7528\u6237\u624b\u52a8\u7f16\u5199 proto \u6587\u4ef6\uff0c\u4ee5\u53ca\u751f\u6210 js \u670d\u52a1\uff0c\u6700\u540e\u518d\u6839\u636e js \u751f\u6210\u7684\u670d\u52a1\u518d\u7f16\u5199\u5b9e\u73b0\uff0c\u5728 Midway \u4f53\u7cfb\u4e0b\uff0c\u6211\u4eec\u63d0\u4f9b\u4e86\u4e00\u4e2a grpc-helper \u5de5\u5177\u5305\u6765\u52a0\u901f\u8fd9\u4e2a\u8fc7\u7a0b\u3002"),(0,a.kt)("p",null,"\u5982\u679c\u6ca1\u6709\u5b89\u88c5\uff0c\u53ef\u4ee5\u5148\u5b89\u88c5\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"$ npm i @midwayjs/grpc-helper --save-dev\n")),(0,a.kt)("p",null,"grpc-helper \u5de5\u5177\u7684\u4f5c\u7528\uff0c\u662f\u5c06\u7528\u6237\u63d0\u4f9b\u7684 proto \u6587\u4ef6\uff0c\u751f\u6210\u5bf9\u5e94\u53ef\u8bfb\u7684 ts interface \u6587\u4ef6\u3002"),(0,a.kt)("p",null,"\u6211\u4eec\u53ef\u4ee5\u6dfb\u52a0\u4e00\u4e2a\u811a\u672c\uff0c\u65b9\u4fbf\u8fd9\u4e2a\u8fc7\u7a0b\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "scripts": {\n     "generate": "tsproto --path proto --output src/domain"\n  }\n}\n')),(0,a.kt)("p",null,"\u7136\u540e\u6267\u884c ",(0,a.kt)("inlineCode",{parentName:"p"},"npm run generate")," \u3002"),(0,a.kt)("p",null,"\u4e0a\u8ff0\u547d\u4ee4\u6267\u884c\u540e\uff0c\u4f1a\u5728\u4ee3\u7801\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"src/domain")," \u76ee\u5f55\u4e2d\u751f\u6210 proto \u6587\u4ef6\u5bf9\u5e94\u7684\u670d\u52a1\u63a5\u53e3\u5b9a\u4e49\u3002"),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"\u4e0d\u7ba1\u662f\u63d0\u4f9b gRPC \u670d\u52a1\u8fd8\u662f\u8c03\u7528 gRPC \u670d\u52a1\uff0c\u90fd\u8981\u5148\u751f\u6210\u5b9a\u4e49\u3002")),(0,a.kt)("p",null,"\u751f\u6210\u7684\u4ee3\u7801\u5982\u4e0b\uff0c\u5305\u542b\u6709\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\uff08namespace\uff09\uff0c\u4ee5\u53ca\u547d\u540d\u7a7a\u95f4\u4e0b\u7684\u4e24\u4e2a TypeScript Interface\uff0c ",(0,a.kt)("inlineCode",{parentName:"p"},"Greeter")," \u7528\u4e8e\u7f16\u5199\u670d\u52a1\u7aef\u5b9e\u73b0\uff0c ",(0,a.kt)("inlineCode",{parentName:"p"},"GreeterClient")," \u7528\u4e8e\u7f16\u5199\u5ba2\u6237\u7aef\u5b9e\u73b0\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"/**\n* This file is auto-generated by grpc-helper\n*/\n\nimport * as grpc from '@midwayjs/grpc';\n\n// \u751f\u6210\u7684\u547d\u540d\u7a7a\u95f4\nexport namespace helloworld {\n\n  // \u670d\u52a1\u7aef\u4f7f\u7528\u7684\u5b9a\u4e49\n  export interface Greeter {\n    // Sends a greeting\n    sayHello(data: HelloRequest): Promise<HelloReply>;\n  }\n\n  // \u5ba2\u6237\u7aef\u4f7f\u7528\u7684\u5b9a\u4e49\n  export interface GreeterClient {\n    // Sends a greeting\n    sayHello(options?: grpc.IClientOptions): grpc.IClientUnaryService<HelloRequest, HelloReply>;\n  }\n\n  // \u8bf7\u6c42\u4f53\u7ed3\u6784\n  export interface HelloRequest {\n    name?: string;\n  }\n\n  // \u54cd\u5e94\u4f53\u7ed3\u6784\n  export interface HelloReply {\n    message?: string;\n  }\n}\n\n")),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"\u6bcf\u5f53 proto \u6587\u4ef6\u88ab\u4fee\u6539\u65f6\uff0c\u5c31\u9700\u8981\u91cd\u65b0\u751f\u6210\u5bf9\u5e94\u7684\u670d\u52a1\u5b9a\u4e49\uff0c\u7136\u540e\u5c06\u5bf9\u5e94\u7684\u65b9\u6cd5\u5b9e\u73b0\u3002")),(0,a.kt)("h2",{id:"\u63d0\u4f9b-grpc-\u670d\u52a1provider"},"\u63d0\u4f9b gRPC \u670d\u52a1\uff08Provider\uff09"),(0,a.kt)("h3",{id:"\u7f16\u5199\u670d\u52a1\u63d0\u4f9b\u65b9provider"},"\u7f16\u5199\u670d\u52a1\u63d0\u4f9b\u65b9\uff08Provider\uff09"),(0,a.kt)("p",null,"\u5728 ",(0,a.kt)("inlineCode",{parentName:"p"},"src/provider")," \u76ee\u5f55\u4e2d\uff0c\u6211\u4eec\u521b\u5efa ",(0,a.kt)("inlineCode",{parentName:"p"},"greeter.ts")," \uff0c\u5185\u5bb9\u5982\u4e0b"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import {\n  MSProviderType,\n  Provider,\n  GrpcMethod,\n} from '@midwayjs/core';\nimport { helloworld } from '../domain/helloworld';\n\n/**\n * \u5b9e\u73b0 helloworld.Greeter \u63a5\u53e3\u7684\u670d\u52a1\n */\n@Provider(MSProviderType.GRPC, { package: 'helloworld' })\nexport class Greeter implements helloworld.Greeter {\n\n  @GrpcMethod()\n  async sayHello(request: helloworld.HelloRequest) {\n    return { message: 'Hello ' + request.name };\n  }\n}\n\n")),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"\u6ce8\u610f\uff0c@Provider \u88c5\u9970\u5668\u548c @Provide \u88c5\u9970\u5668\u4e0d\u540c\uff0c\u524d\u8005\u7528\u4e8e\u63d0\u4f9b\u670d\u52a1\uff0c\u540e\u8005\u7528\u4e8e\u4f9d\u8d56\u6ce8\u5165\u5bb9\u5668\u626b\u63cf\u6807\u8bc6\u7684\u7c7b\u3002")),(0,a.kt)("p",null,"\u6211\u4eec\u4f7f\u7528 ",(0,a.kt)("inlineCode",{parentName:"p"},"@Provider")," \u66b4\u9732\u51fa\u4e00\u4e2a RPC \u670d\u52a1\uff0c ",(0,a.kt)("inlineCode",{parentName:"p"},"@Provider")," \u7684\u7b2c\u4e00\u4e2a\u53c2\u6570\u4e3a RPC \u670d\u52a1\u7c7b\u578b\uff0c\u8fd9\u4e2a\u53c2\u6570\u662f\u4e2a\u679a\u4e3e\uff0c\u8fd9\u91cc\u9009\u62e9 GRPC \u7c7b\u578b\u3002"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"@Provider")," \u7684\u7b2c\u4e8c\u4e2a\u53c2\u6570\u4e3a RPC \u670d\u52a1\u7684\u5143\u6570\u636e\uff0c\u8fd9\u91cc\u6307\u4ee3\u7684\u662f gRPC \u670d\u52a1\u7684\u5143\u6570\u636e\u3002\u8fd9\u91cc\u9700\u8981\u5199\u5165 gRPC \u7684 package \u5b57\u6bb5\uff0c\u5373 proto \u6587\u4ef6\u4e2d\u7684 package \u5b57\u6bb5\uff08\u8fd9\u91cc\u7684\u5b57\u6bb5\u7528\u4e8e\u548c proto \u6587\u4ef6\u52a0\u8f7d\u540e\u7684\u5b57\u6bb5\u505a\u5bf9\u5e94\uff09\u3002"),(0,a.kt)("p",null,"\u5bf9\u4e8e\u666e\u901a\u7684 gRPC \u670d\u52a1\u63a5\u53e3\uff08UnaryCall\uff09\uff0c\u6211\u4eec\u53ea\u9700\u8981\u4f7f\u7528 ",(0,a.kt)("inlineCode",{parentName:"p"},"@GrpcMethod()")," \u88c5\u9970\u5668\u4fee\u9970\u5373\u53ef\u3002\u4fee\u9970\u7684\u65b9\u6cd5\u5373\u4e3a\u670d\u52a1\u5b9a\u4e49\u672c\u8eab\uff0c\u5165\u53c2\u4e3a proto \u4e2d\u5b9a\u4e49\u597d\u7684\u5165\u53c2\uff0creturn \u503c\u5373\u4e3a\u5b9a\u4e49\u597d\u7684\u54cd\u5e94\u4f53\u3002"),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"\u6ce8\u610f\uff0c\u751f\u6210\u7684 Interface \u662f\u4e3a\u4e86\u66f4\u597d\u7684\u7f16\u5199\u670d\u52a1\u4ee3\u7801\uff0c\u89c4\u8303\u7ed3\u6784\uff0c\u8bf7\u52a1\u5fc5\u6309\u7167\u5b9a\u4e49\u7f16\u5199\u3002")),(0,a.kt)("h3",{id:"\u914d\u7f6e\u670d\u52a1"},"\u914d\u7f6e\u670d\u52a1"),(0,a.kt)("p",null,"\u914d\u7f6e\u5185\u5bb9\u5982\u4e0b\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default\nimport { MidwayAppInfo, MidwayConfig } from '@midwayjs/core';\n\nexport default (appInfo: MidwayAppInfo): MidwayConfig => {\n  return {\n    // ...\n    grpcServer: {\n      services: [\n        {\n          protoPath: join(appInfo.appDir, 'proto/hero.proto'),\n          package: 'hero',\n        },\n        {\n          protoPath: join(appInfo.appDir, 'proto/helloworld.proto'),\n          package: 'helloworld',\n        }\n      ],\n    }\n  };\n}\n")),(0,a.kt)("p",null,"services \u5b57\u6bb5\u662f\u6570\u7ec4\uff0c\u610f\u5473\u7740 Midway \u9879\u76ee\u53ef\u4ee5\u540c\u65f6\u53d1\u5e03\u591a\u4e2a gRPC \u670d\u52a1\u3002\u6bcf\u4e2a service \u7684\u7ed3\u6784\u4e3a\uff1a"),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"\u5c5e\u6027"),(0,a.kt)("th",{parentName:"tr",align:null},"\u7c7b\u578b"),(0,a.kt)("th",{parentName:"tr",align:null},"\u63cf\u8ff0"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"protoPath"),(0,a.kt)("td",{parentName:"tr",align:null},"string"),(0,a.kt)("td",{parentName:"tr",align:null},"\u5fc5\u9009\uff0cproto \u6587\u4ef6\u7684\u7edd\u5bf9\u8def\u5f84")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"package"),(0,a.kt)("td",{parentName:"tr",align:null},"string"),(0,a.kt)("td",{parentName:"tr",align:null},"\u5fc5\u9009\uff0c\u670d\u52a1\u5bf9\u5e94\u7684 package")))),(0,a.kt)("p",null,"\u9664\u4e86 Service \u914d\u7f6e\u4e4b\u5916\uff0c\u8fd8\u6709\u4e00\u4e9b\u5176\u4ed6\u7684\u914d\u7f6e\u3002"),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"\u5c5e\u6027"),(0,a.kt)("th",{parentName:"tr",align:null},"\u7c7b\u578b"),(0,a.kt)("th",{parentName:"tr",align:null},"\u63cf\u8ff0"))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"url"),(0,a.kt)("td",{parentName:"tr",align:null},"string"),(0,a.kt)("td",{parentName:"tr",align:null},"\u53ef\u9009\uff0cgRPC \u670d\u52a1\u5730\u5740\uff0c\u9ed8\u8ba4 6565 \u7aef\u53e3\uff0c\u6bd4\u5982 'localhost:6565'")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"loaderOptions"),(0,a.kt)("td",{parentName:"tr",align:null},"Object"),(0,a.kt)("td",{parentName:"tr",align:null},"\u53ef\u9009\uff0cproto file loader \u7684 options")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"credentials"),(0,a.kt)("td",{parentName:"tr",align:null},"ServerCredentials"),(0,a.kt)("td",{parentName:"tr",align:null},"\u53ef\u9009\uff0cgrpc Server binding \u65f6\u7684 credentials \u53c2\u6570\u9009\u9879")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"serverOptions"),(0,a.kt)("td",{parentName:"tr",align:null},"ChannelOptions"),(0,a.kt)("td",{parentName:"tr",align:null},"\u53ef\u9009\uff0cgrpc Server \u7684 ",(0,a.kt)("a",{parentName:"td",href:"https://github.com/grpc/grpc-node/tree/master/packages/grpc-js#supported-channel-options"},"\u81ea\u5b9a\u4e49 options"))))),(0,a.kt)("h3",{id:"\u63d0\u4f9b\u5b89\u5168\u8bc1\u4e66"},"\u63d0\u4f9b\u5b89\u5168\u8bc1\u4e66"),(0,a.kt)("p",null,"\u53ef\u4ee5\u901a\u8fc7 ",(0,a.kt)("inlineCode",{parentName:"p"},"credentials")," \u53c2\u6570\u4f20\u9012\u5b89\u5168\u8bc1\u4e66\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default\nimport { MidwayAppInfo, MidwayConfig } from '@midwayjs/core';\nimport { ServerCredentials } from '@midwayjs/grpc';\nimport { readFileSync } from 'fs';\nimport { join } from 'path';\n\nconst cert = readFileSync(join(__dirname, './cert/server.crt'));\nconst pem = readFileSync(join(__dirname, './cert/server.pem'));\nconst key = readFileSync(join(__dirname, './cert/server.key'));\n\nexport default (appInfo: MidwayAppInfo): MidwayConfig => {\n  return {\n    // ...\n    grpcServer: {\n      // ...\n      credentials: ServerCredentials.createSsl(cert, [{ private_key: key, cert_chain: pem }]);\n    }\n  };\n}\n")),(0,a.kt)("h3",{id:"\u7f16\u5199\u5355\u5143\u6d4b\u8bd5"},"\u7f16\u5199\u5355\u5143\u6d4b\u8bd5"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"@midwayjs/grpc")," \u5e93\u63d0\u4f9b\u4e86\u4e00\u4e2a ",(0,a.kt)("inlineCode",{parentName:"p"},"createGRPCConsumer")," \u65b9\u6cd5\uff0c\u7528\u4e8e\u5b9e\u65f6\u8c03\u7528\u5ba2\u6237\u7aef\uff0c\u4e00\u822c\u6211\u4eec\u7528\u8fd9\u4e2a\u65b9\u6cd5\u505a\u6d4b\u8bd5\u3002"),(0,a.kt)("admonition",{type:"caution"},(0,a.kt)("p",{parentName:"admonition"},"\u8fd9\u4e2a\u65b9\u6cd5\u6bcf\u6b21\u8c03\u7528\u4f1a\u5b9e\u65f6\u8fde\u63a5\uff0c\u4e0d\u5efa\u8bae\u5c06\u8be5\u65b9\u6cd5\u7528\u5728\u751f\u4ea7\u73af\u5883\u3002")),(0,a.kt)("p",null,"\u5728\u6d4b\u8bd5\u4e2d\u5199\u6cd5\u5982\u4e0b\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { createApp, close } from '@midwayjs/mock';\nimport { Framework, createGRPCConsumer } from '@midwayjs/grpc';\nimport { join } from 'path';\nimport { helloworld } from '../src/domain/helloworld';\n\ndescribe('test/index.test.ts', () => {\n\n  it('should create multiple grpc service in one server', async () => {\n    const baseDir = join(__dirname, '../');\n\n    // \u521b\u5efa\u670d\u52a1\n    const app = await createApp<Framework>();\n\n    // \u8c03\u7528\u670d\u52a1\n    const service = await createGRPCConsumer<helloworld.GreeterClient>({\n      package: 'helloworld',\n      protoPath: join(baseDir, 'proto', 'helloworld.proto'),\n      url: 'localhost:6565'\n    });\n\n    const result = await service.sayHello().sendMessage({\n      name: 'harry'\n    });\n\n    expect(result.message).toEqual('Hello harry');\n    await close(app);\n  });\n\n});\n\n")),(0,a.kt)("h2",{id:"\u8c03\u7528-grpc-\u670d\u52a1consumer"},"\u8c03\u7528 gRPC \u670d\u52a1\uff08Consumer\uff09"),(0,a.kt)("p",null,"\u6211\u4eec\u7f16\u5199\u4e00\u4e2a gRPC \u670d\u52a1\u6765\u8c03\u7528\u4e0a\u9762\u7684\u66b4\u9732\u7684\u670d\u52a1\u3002"),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"\u4e8b\u5b9e\u4e0a\uff0c\u4f60\u53ef\u4ee5\u5728 Web \u7684 Controller\uff0c\u6216\u8005 Service \u7b49\u5176\u4ed6\u5730\u65b9\u6765\u8c03\u7528\uff0c\u8fd9\u91cc\u53ea\u662f\u505a\u4e00\u4e2a\u793a\u4f8b\u3002")),(0,a.kt)("h3",{id:"\u8c03\u7528\u914d\u7f6e"},"\u8c03\u7528\u914d\u7f6e"),(0,a.kt)("p",null,"\u4f60\u9700\u8981\u5728 ",(0,a.kt)("inlineCode",{parentName:"p"},"src/config/config.default.ts")," \u4e2d\u589e\u52a0\u4f60\u9700\u8981\u8c03\u7528\u7684\u76ee\u6807\u670d\u52a1\u4ee5\u53ca\u5b83\u7684 proto \u6587\u4ef6\u4fe1\u606f\u3002"),(0,a.kt)("p",null,"\u6bd4\u5982\uff0c\u8fd9\u91cc\u6211\u4eec\u586b\u5199\u4e86\u4e0a\u9762\u66b4\u9732\u7684\u670d\u52a1\u672c\u8eab\uff0c\u4ee5\u53ca\u8be5\u670d\u52a1\u7684 proto\uff0c\u5305\u540d\u7b49\u4fe1\u606f\uff08\u51fd\u6570\u5f62\u5f0f\uff09\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default\nimport { MidwayAppInfo, MidwayConfig } from '@midwayjs/core';\n\nexport default (appInfo: MidwayAppInfo): MidwayConfig => {\n  return {\n    // ...\n    grpc: {\n      services: [\n        {\n          url: 'localhost:6565',\n          protoPath: join(appInfo.appDir, 'proto/helloworld.proto'),\n          package: 'helloworld',\n        },\n      ],\n    },\n  };\n}\n")),(0,a.kt)("h3",{id:"\u4ee3\u7801\u8c03\u7528"},"\u4ee3\u7801\u8c03\u7528"),(0,a.kt)("p",null,"\u914d\u7f6e\u5b8c\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5728\u4ee3\u7801\u91cc\u8c03\u7528\u4e86\u3002"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"@midwayjs/grpc")," \u63d0\u4f9b\u4e86 ",(0,a.kt)("inlineCode",{parentName:"p"},"clients")," \uff0c\u53ef\u4ee5\u65b9\u4fbf\u7684\u83b7\u53d6\u5230\u5df2\u914d\u7f6e\u7684\u670d\u52a1\u3002\u6211\u4eec\u53ea\u9700\u8981\u5728\u9700\u8981\u6ce8\u5165\u7684\u5730\u65b9\uff0c\u6ce8\u5165\u8fd9\u4e2a\u5bf9\u8c61\u5373\u53ef\u3002"),(0,a.kt)("p",null,"\u6bd4\u5982\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import {\n  Provide,\n  Inject,\n} from '@midwayjs/core';\nimport { helloworld, hero } from '../interface';\nimport { Clients } from '@midwayjs/grpc';\n\n@Provide()\nexport class UserService {\n  @Inject()\n  grpcClients: Clients;\n\n}\n")),(0,a.kt)("p",null,"\u6211\u4eec\u901a\u8fc7 ",(0,a.kt)("inlineCode",{parentName:"p"},"clients")," \u83b7\u53d6\u5230\u5bf9\u65b9\u670d\u52a1\u7684\u5ba2\u6237\u7aef\u5b9e\u4f8b\uff0c\u7136\u540e\u8c03\u7528\u5373\u53ef\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import {\n  Provide,\n  Inject,\n} from '@midwayjs/core';\nimport { helloworld, hero } from '../interface';\nimport { Clients } from '@midwayjs/grpc';\n\n@Provide()\nexport class UserService {\n  @Inject()\n  grpcClients: Clients;\n\n  async invoke() {\n    // \u83b7\u53d6\u670d\u52a1\n    const greeterService = this.grpcClients.getService<helloworld.GreeterClient>(\n      'helloworld.Greeter'\n    );\n\n    // \u8c03\u7528\u670d\u52a1\n    const result = await greeterService.sayHello()\n        .sendMessage({\n        name: 'harry'\n      });\n\n    // \u8fd4\u56de\u7ed3\u679c\n    return result;\n  }\n\n}\n")),(0,a.kt)("p",null,"\u6211\u4eec\u4e5f\u53ef\u4ee5\u5229\u7528 ",(0,a.kt)("inlineCode",{parentName:"p"},"@Init")," \u88c5\u9970\u5668\uff0c\u5c06\u9700\u8981\u8c03\u7528\u7684\u670d\u52a1\u7f13\u5b58\u5230\u5c5e\u6027\u4e0a\u3002\u8fd9\u6837\u53ef\u4ee5\u5728\u5176\u4ed6\u65b9\u6cd5\u8c03\u7528\u65f6\u590d\u7528\u3002"),(0,a.kt)("p",null,"\u793a\u4f8b\u5982\u4e0b\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import {\n  GrpcMethod,\n  MSProviderType,\n  Provider,\n  Inject,\n  Init,\n} from '@midwayjs/core';\nimport { helloworld, hero } from '../interface';\nimport { Clients } from '@midwayjs/grpc';\n\n@Provider(MSProviderType.GRPC, { package: 'hero' })\nexport class HeroService implements hero.HeroService {\n  // \u6ce8\u5165\u5ba2\u6237\u7aef\n  @Inject()\n  grpcClients: Clients;\n\n  greeterService: helloworld.GreeterClient;\n\n  @Init()\n  async init() {\n    // \u8d4b\u503c\u4e00\u4e2a\u670d\u52a1\u5b9e\u4f8b\n    this.greeterService = this.grpcClients.getService<helloworld.GreeterClient>(\n      'helloworld.Greeter'\n    );\n  }\n\n  @GrpcMethod()\n  async findOne(data) {\n    // \u8c03\u7528\u670d\u52a1\n    const result = await greeterService.sayHello()\n        .sendMessage({\n        name: 'harry'\n      });\n\n    // \u8fd4\u56de\u7ed3\u679c\n    return result;\n  }\n}\n\n")),(0,a.kt)("h2",{id:"\u6d41\u5f0f\u670d\u52a1"},"\u6d41\u5f0f\u670d\u52a1"),(0,a.kt)("p",null,"gRPC \u7684\u6d41\u5f0f\u670d\u52a1\u7528\u4e8e\u51cf\u5c11\u8fde\u63a5\uff0c\u8ba9\u670d\u52a1\u7aef\u6216\u8005\u5ba2\u6237\u7aef\u4e0d\u9700\u8981\u7b49\u5f85\u5373\u53ef\u6267\u884c\u4efb\u52a1\uff0c\u4ece\u800c\u63d0\u9ad8\u6267\u884c\u6548\u7387\u3002"),(0,a.kt)("p",null,"gRPC \u7684\u6d41\u5f0f\u670d\u52a1\u5206\u4e3a\u4e09\u79cd\uff0c\u4ee5\u670d\u52a1\u7aef\u89d2\u5ea6\u6765\u8bf4\uff0c\u4e3a"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\u670d\u52a1\u7aef\u63a5\u6536\u6d41\uff08\u5ba2\u6237\u7aef\u63a8\uff09"),(0,a.kt)("li",{parentName:"ul"},"\u670d\u52a1\u7aef\u54cd\u5e94\u6d41\uff08\u670d\u52a1\u7aef\u63a8\uff09"),(0,a.kt)("li",{parentName:"ul"},"\u53cc\u5411\u6d41")),(0,a.kt)("p",null,"\u4e0b\u9762\u6211\u4eec\u5c06\u4e00\u4e00\u4ecb\u7ecd\u3002"),(0,a.kt)("h3",{id:"\u6d41\u5f0f-proto-\u6587\u4ef6"},"\u6d41\u5f0f proto \u6587\u4ef6"),(0,a.kt)("p",null,"\u6d41\u5f0f\u7684 proto \u6587\u4ef6\u5199\u6cd5\u4e0d\u540c\uff0c\u9700\u8981\u5728\u5e0c\u671b\u4f7f\u7528\u6d41\u5f0f\u7684\u5730\u65b9\u5c06\u53c2\u6570\u6807\u8bb0\u4e3a ",(0,a.kt)("inlineCode",{parentName:"p"},"stream")," \u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-protobuf"},'\nsyntax = "proto3";\n\npackage math;\n\nmessage AddArgs {\n  int32 id = 1;\n  int32 num = 2;\n}\n\nmessage Num {\n  int32 id = 1;\n  int32 num = 2;\n}\n\nservice Math {\n  rpc Add (AddArgs) returns (Num) {\n  }\n\n    // \u53cc\u5411\u6d41\n  rpc AddMore (stream AddArgs) returns (stream Num) {\n  }\n\n  // \u670d\u52a1\u7aef\u5f80\u5ba2\u6237\u7aef\u63a8\n  rpc SumMany (AddArgs) returns (stream Num) {\n  }\n\n  // \u5ba2\u6237\u7aef\u5f80\u670d\u52a1\u7aef\u63a8\n  rpc AddMany (stream AddArgs) returns (Num) {\n  }\n}\n\n')),(0,a.kt)("p",null,"\u8be5\u670d\u52a1\u751f\u6210\u7684\u63a5\u53e3\u5b9a\u4e49\u4e3a\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import {\n  IClientDuplexStreamService,\n  IClientReadableStreamService,\n  IClientUnaryService,\n  IClientWritableStreamService,\n  IClientOptions,\n} from '@midwayjs/grpc';\n\nexport namespace math {\n  export interface AddArgs {\n    id?: number;\n    num?: number;\n  }\n  export interface Num {\n    id?: number;\n    num?: number;\n  }\n\n  /**\n   * server interface\n   */\n  export interface Math {\n    add(data: AddArgs): Promise<Num>;\n    addMore(data: AddArgs): Promise<void>;\n    // \u670d\u52a1\u7aef\u63a8\uff0c\u5ba2\u6237\u7aef\u8bfb\n    sumMany(data: AddArgs): Promise<void>\n    // \u5ba2\u6237\u7aef\u7aef\u63a8\uff0c\u670d\u52a1\u7aef\u8bfb\n    addMany(num: AddArgs): Promise<void>;\n  }\n\n  /**\n   * client interface\n   */\n  export interface MathClient {\n    add(options?: IClientOptions): IClientUnaryService<AddArgs, Num>;\n    addMore(options?: IClientOptions): IClientDuplexStreamService<AddArgs, Num>;\n    // \u670d\u52a1\u7aef\u63a8\uff0c\u5ba2\u6237\u7aef\u8bfb\n    sumMany(options?: IClientOptions): IClientReadableStreamService<AddArgs, Num>;\n    // \u5ba2\u6237\u7aef\u7aef\u63a8\uff0c\u670d\u52a1\u7aef\u8bfb\n    addMany(options?: IClientOptions): IClientWritableStreamService<AddArgs, Num>;\n  }\n}\n\n")),(0,a.kt)("h3",{id:"\u670d\u52a1\u7aef\u63a8\u9001"},"\u670d\u52a1\u7aef\u63a8\u9001"),(0,a.kt)("p",null,"\u5ba2\u6237\u7aef\u8c03\u7528\u4e00\u6b21\uff0c\u670d\u52a1\u7aef\u53ef\u4ee5\u591a\u6b21\u8fd4\u56de\u3002\u901a\u8fc7 ",(0,a.kt)("inlineCode",{parentName:"p"},"@GrpcMethod()")," \u7684\u53c2\u6570\u6765\u6807\u8bc6\u6d41\u5f0f\u7c7b\u578b\u3002"),(0,a.kt)("p",null,"\u53ef\u7528\u7684\u7c7b\u578b\u4e3a:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"GrpcStreamTypeEnum.WRITEABLE"),"  \u670d\u52a1\u7aef\u8f93\u51fa\u6d41\uff08\u5355\u5de5\uff09"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"GrpcStreamTypeEnum.READABLE"),"  \u5ba2\u6237\u7aef\u8f93\u51fa\u6d41\uff08\u5355\u5de5\uff09\uff0c\u670d\u52a1\u7aef\u63a5\u53d7\u591a\u6b21"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"GrpcStreamTypeEnum.DUPLEX"),"  \u53cc\u5de5\u6d41")),(0,a.kt)("p",null,"\u670d\u52a1\u7aef\u793a\u4f8b\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { GrpcMethod, GrpcStreamTypeEnum, Inject, MSProviderType, Provider } from '@midwayjs/core';\nimport { Context, Metadata } from '@midwayjs/grpc';\nimport { math } from '../interface';\n\n/**\n */\n@Provider(MSProviderType.GRPC, { package: 'math' })\nexport class Math implements math.Math {\n\n  @Inject()\n  ctx: Context;\n\n  @GrpcMethod({type: GrpcStreamTypeEnum.WRITEABLE })\n  async sumMany(args: math.AddArgs) {\n    this.ctx.write({\n      num: 1 + args.num\n    });\n    this.ctx.write({\n      num: 2 + args.num\n    });\n    this.ctx.write({\n      num: 3 + args.num\n    });\n\n    this.ctx.end();\n  }\n\n  // ...\n}\n\n")),(0,a.kt)("p",null,"\u670d\u52a1\u7aef\u4f7f\u7528 ",(0,a.kt)("inlineCode",{parentName:"p"},"ctx.write")," \u65b9\u6cd5\u6765\u8fd4\u56de\u6570\u636e\uff0c\u7531\u4e8e\u662f\u670d\u52a1\u7aef\u6d41\uff0c\u53ef\u4ee5\u8fd4\u56de\u591a\u6b21\u3002"),(0,a.kt)("p",null,"\u8fd4\u56de\u7ed3\u675f\u540e\uff0c\u8bf7\u4f7f\u7528 ",(0,a.kt)("inlineCode",{parentName:"p"},"ctx.end()")," \u65b9\u6cd5\u5173\u95ed\u6d41\u3002"),(0,a.kt)("p",null,"\u5ba2\u6237\u7aef\uff0c\u8c03\u7528\u4e00\u6b21\uff0c\u63a5\u53d7\u591a\u6b21\u6570\u636e\u3002"),(0,a.kt)("p",null,"\u6bd4\u5982\u4e0b\u9762\u7684\u7d2f\u52a0\u903b\u8f91\u3002"),(0,a.kt)("p",null,"Promise \u5199\u6cd5\uff0c\u4f1a\u7b49\u5f85\u670d\u52a1\u7aef\u6570\u636e\u90fd\u8fd4\u56de\u518d\u505a\u5904\u7406\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// \u670d\u52a1\u7aef\u63a8\u9001\nlet total = 0;\nlet result = await service.sumMany().sendMessage({\n  num: 1,\n});\n\nresult.forEach(data => {\n  total += data.num;\n});\n\n// total = 9;\n")),(0,a.kt)("p",null,"\u4e8b\u4ef6\u5199\u6cd5\uff0c\u5b9e\u65f6\u5904\u7406\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// \u670d\u52a1\u7aef\u63a8\u9001\nlet call = service.sumMany().getCall();\n\ncall.on('data', data => {\n    // do something\n});\n\ncall.sendMessage({\n  num: 1,\n});\n\n")),(0,a.kt)("h3",{id:"\u5ba2\u6237\u7aef\u63a8\u9001"},"\u5ba2\u6237\u7aef\u63a8\u9001"),(0,a.kt)("p",null,"\u5ba2\u6237\u7aef\u8c03\u7528\u591a\u6b21\uff0c\u670d\u52a1\u7aef\u63a5\u6536\u591a\u6b21\u6570\u636e\uff0c\u8fd4\u56de\u4e00\u4e2a\u7ed3\u679c\u3002\u901a\u8fc7 ",(0,a.kt)("inlineCode",{parentName:"p"},"@GrpcMethod({type: GrpcStreamTypeEnum.READABLE})")," \u7684\u53c2\u6570\u6765\u6807\u8bc6\u6d41\u5f0f\u7c7b\u578b\u3002"),(0,a.kt)("p",null,"\u670d\u52a1\u7aef\u793a\u4f8b\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { GrpcMethod, GrpcStreamTypeEnum, Inject, MSProviderType, Provider } from '@midwayjs/core';\nimport { Context, Metadata } from '@midwayjs/grpc';\nimport { math } from '../interface';\n\n/**\n */\n@Provider(MSProviderType.GRPC, { package: 'math' })\nexport class Math implements math.Math {\n\n  sumDataList: number[] = [];\n\n  @Inject()\n  ctx: Context;\n\n  @GrpcMethod({type: GrpcStreamTypeEnum.READABLE, onEnd: 'sumEnd' })\n  async addMany(data: math.Num) {\n    this.sumDataList.push(data);\n  }\n\n  async sumEnd(): Promise<math.Num> {\n    const total = this.sumDataList.reduce((pre, cur) => {\n      return {\n        num: pre.num + cur.num,\n      }\n    });\n    return total;\n  }\n\n  // ...\n}\n\n")),(0,a.kt)("p",null,"\u5ba2\u6237\u7aef\u6bcf\u6b21\u8c03\u7528\uff0c\u90fd\u4f1a\u89e6\u53d1\u4e00\u6b21 ",(0,a.kt)("inlineCode",{parentName:"p"},"addMany")," \u65b9\u6cd5\u3002"),(0,a.kt)("p",null,"\u5728\u5ba2\u6237\u7aef\u53d1\u9001 ",(0,a.kt)("inlineCode",{parentName:"p"},"end")," \u4e8b\u4ef6\u4e4b\u540e\uff0c\u4f1a\u8c03\u7528 ",(0,a.kt)("inlineCode",{parentName:"p"},"@GrpcMethod")," \u88c5\u9970\u5668\u4e0a\u7684 ",(0,a.kt)("inlineCode",{parentName:"p"},"onEnd")," \u53c2\u6570\u6307\u5b9a\u7684\u65b9\u6cd5\uff0c\u8be5\u65b9\u6cd5\u7684\u8fd4\u56de\u503c\u5373\u4e3a\u6700\u540e\u5ba2\u6237\u7aef\u62ff\u5230\u7684\u503c\u3002"),(0,a.kt)("p",null,"\u5ba2\u6237\u7aef\u793a\u4f8b\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// \u5ba2\u6237\u7aef\u63a8\u9001\nconst data = await service.addMany()\n.sendMessage({num: 1})\n.sendMessage({num: 2})\n.sendMessage({num: 3})\n.end();\n\n// data.num = 6\n")),(0,a.kt)("h3",{id:"\u53cc\u5411\u6d41"},"\u53cc\u5411\u6d41"),(0,a.kt)("p",null,"\u5ba2\u6237\u7aef\u53ef\u4ee5\u8c03\u7528\u591a\u6b21\uff0c\u670d\u52a1\u7aef\u4e5f\u53ef\u4ee5\u63a5\u6536\u591a\u6b21\u6570\u636e\uff0c\u8fd4\u56de\u591a\u4e2a\u7ed3\u679c\uff0c\u7c7b\u4f3c\u4e8e\u4f20\u7edf\u7684 TCP \u901a\u4fe1\u3002\u901a\u8fc7 ",(0,a.kt)("inlineCode",{parentName:"p"},"@GrpcMethod({type: GrpcStreamTypeEnum.DUPLEX})")," \u7684\u53c2\u6570\u6765\u6807\u8bc6\u53cc\u5de5\u6d41\u5f0f\u7c7b\u578b\u3002"),(0,a.kt)("p",null,"\u670d\u52a1\u7aef\u793a\u4f8b\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { GrpcMethod, GrpcStreamTypeEnum, Inject, MSProviderType, Provider } from '@midwayjs/core';\nimport { Context, Metadata } from '@midwayjs/grpc';\nimport { math } from '../interface';\n\n/**\n */\n@Provider(MSProviderType.GRPC, { package: 'math' })\nexport class Math implements math.Math {\n\n  @Inject()\n  ctx: Context;\n\n  @GrpcMethod({type: GrpcStreamTypeEnum.DUPLEX, onEnd: 'duplexEnd' })\n  async addMore(message: math.AddArgs)  {\n    this.ctx.write({\n      id: message.id,\n      num: message.num + 10,\n    });\n  }\n\n  async duplexEnd() {\n    console.log('got client end message');\n  }\n  // ...\n}\n\n")),(0,a.kt)("p",null,"\u670d\u52a1\u7aef\u53ef\u4ee5\u968f\u65f6\u4f7f\u7528 ",(0,a.kt)("inlineCode",{parentName:"p"},"ctx.write")," \u8fd4\u56de\u6570\u636e\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528 ",(0,a.kt)("inlineCode",{parentName:"p"},"ctx.end")," \u6765\u5173\u95ed\u6d41\u3002"),(0,a.kt)("p",null,"\u5ba2\u6237\u7aef\u793a\u4f8b\uff1a"),(0,a.kt)("p",null,"\u5bf9\u4e8e\u53cc\u5de5\u901a\u4fe1\u7684\u5ba2\u6237\u7aef\uff0c\u7531\u4e8e\u65e0\u6cd5\u4fdd\u8bc1\u8c03\u7528\u3001\u8fd4\u56de\u7684\u987a\u5e8f\uff0c\u6211\u4eec\u9700\u8981\u4f7f\u7528\u76d1\u542c\u7684\u6a21\u5f0f\u6765\u6d88\u8d39\u7ed3\u679c\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"const clientStream = service.addMore().getCall();\n\nlet total = 0;\nlet idx = 0;\n\nduplexCall.on('data', (data: math.Num) => {\n  total += data.num;\n  idx++;\n  if (idx === 2) {\n    duplexCall.end();\n    // total => 29\n  }\n});\n\nduplexCall.write({\n  num: 3,\n});\n\nduplexCall.write({\n  num: 6,\n});\n")),(0,a.kt)("p",null,"\u5982\u679c\u5e0c\u671b\u4fdd\u8bc1\u8c03\u7528\u987a\u5e8f\uff0c\u6211\u4eec\u4e5f\u63d0\u4f9b\u4e86\u4fdd\u8bc1\u987a\u5e8f\u7684\u53cc\u5411\u6d41\u8c03\u7528\u65b9\u6cd5\uff0c\u4f46\u662f\u9700\u8981\u5728 proto \u4e2d\u5b9a\u4e49\u4e00\u4e2a\u56fa\u5b9a\u7684 id\uff0c\u6765\u786e\u4fdd\u987a\u5e8f\u3002"),(0,a.kt)("p",null,"\u6bd4\u5982\u6211\u4eec\u7684 Math.proto\uff0c\u5bf9\u6bcf\u4e2a\u5165\u53c2\u548c\u51fa\u53c2\uff0c\u90fd\u589e\u52a0\u4e86\u4e00\u4e2a\u56fa\u5b9a\u7684 id\uff0c\u6240\u4ee5\u53ef\u4ee5\u56fa\u5b9a\u987a\u5e8f\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},'\nsyntax = "proto3";\n\npackage math;\n\nmessage AddArgs {\n  int32 id = 1;                         //  \u8fd9\u91cc\u7684 id \u540d\u5b57\u662f\u56fa\u5b9a\u7684\n  int32 num = 2;\n}\n\nmessage Num {\n  int32 id = 1;                         //  \u8fd9\u91cc\u7684 id \u540d\u5b57\u662f\u56fa\u5b9a\u7684\n  int32 num = 2;\n}\n\nservice Math {\n  rpc Add (AddArgs) returns (Num) {\n  }\n\n  rpc AddMore (stream AddArgs) returns (stream Num) {\n  }\n\n  // \u670d\u52a1\u7aef\u5f80\u5ba2\u6237\u7aef\u63a8\n  rpc SumMany (AddArgs) returns (stream Num) {\n  }\n\n  // \u5ba2\u6237\u7aef\u5f80\u670d\u52a1\u7aef\u63a8\n  rpc AddMany (stream AddArgs) returns (Num) {\n  }\n}\n\n')),(0,a.kt)("p",null,"\u56fa\u5b9a\u987a\u5e8f\u7684\u5ba2\u6237\u7aef\u8c03\u7528\u65b9\u5f0f\u5982\u4e0b\uff1a"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// \u4fdd\u8bc1\u987a\u5e8f\u7684\u53cc\u5411\u6d41\nconst t = service.addMore();\n\nconst result4 = await new Promise<number>((resolve, reject) => {\n\n  let total = 0;\n\n  // \u7b2c\u4e00\u6b21\u8c03\u7528\u548c\u8fd4\u56de\n  t.sendMessage({\n    num: 2\n  })\n    .then(res => {\n      expect(res.num).toEqual(12);\n      total += res.num;\n    })\n    .catch(err => console.error(err));\n\n  // \u7b2c\u4e8c\u6b21\u8c03\u7528\u548c\u8fd4\u56de\n  t.sendMessage({\n    num: 5\n  }).then(res => {\n      expect(res.num).toEqual(15);\n      total += res.num;\n      resolve(total);\n    })\n    .catch(err => console.error(err));\n\n  t.end();\n});\n\n// result4 => 27\n")),(0,a.kt)("p",null,"\u9ed8\u8ba4\u7684 id \u4e3a ",(0,a.kt)("inlineCode",{parentName:"p"},"id")," \uff0c\u5982\u679c\u670d\u52a1\u7aef\u5b9a\u4e49\u4e0d\u540c\uff0c\u9700\u8981\u4fee\u6539\uff0c\u53ef\u4ee5\u5728\u5ba2\u6237\u7aef\u8c03\u7528\u65f6\u4f20\u9012\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// \u4fdd\u8bc1\u987a\u5e8f\u7684\u53cc\u5411\u6d41\nconst t = service.addMore({\n  messageKey: 'uid'\n});\n")),(0,a.kt)("h2",{id:"\u5143\u6570\u636emetadata"},"\u5143\u6570\u636e\uff08Metadata\uff09"),(0,a.kt)("p",null,"gRPC \u7684\u5143\u6570\u636e\u7b49\u4ef7\u4e8e HTTP \u7684\u4e0a\u4e0b\u6587\u3002"),(0,a.kt)("p",null,"\u670d\u52a1\u7aef\u901a\u8fc7 ",(0,a.kt)("inlineCode",{parentName:"p"},"ctx.sendMetadata")," \u65b9\u6cd5\u8fd4\u56de\u5143\u6570\u636e\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7 ",(0,a.kt)("inlineCode",{parentName:"p"},"ctx.metadata")," \u83b7\u53d6\u5ba2\u6237\u7aef\u4f20\u9012\u7684\u5143\u6570\u636e\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import {\n  MSProviderType,\n  Provider,\n  GrpcMethod,\n} from '@midwayjs/core';\nimport { helloworld } from '../domain/helloworld';\nimport { Context, Metadata } from '@midwayjs/grpc';\n\n/**\n * \u5b9e\u73b0 helloworld.Greeter \u63a5\u53e3\u7684\u670d\u52a1\n */\n@Provider(MSProviderType.GRPC, { package: 'helloworld' })\nexport class Greeter implements helloworld.Greeter {\n\n  @Inject()\n  ctx: Context;\n\n  @GrpcMethod()\n  async sayHello(request: helloworld.HelloRequest) {\n\n    // \u5ba2\u6237\u7aef\u4f20\u9012\u7684\u5143\u6570\u636e\n    console.log(this.ctx.metadata);\n\n    // \u521b\u5efa\u5143\u6570\u636e\n    const meta = new Metadata();\n    this.ctx.metadata.add('xxx', 'bbb');\n    this.ctx.sendMetadata(meta);\n\n    return { message: 'Hello ' + request.name };\n  }\n}\n")),(0,a.kt)("p",null,"\u5ba2\u6237\u7aef\u901a\u8fc7\u65b9\u6cd5\u7684 options \u53c2\u6570\u4f20\u9012\u5143\u6570\u636e\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Metadata } from '@midwayjs/grpc';\n\nconst meta = new Metadata();\nmeta.add('key', 'value');\n\nconst result = await service.sayHello({\n  metadata: meta,\n}).sendMessage({\n  name: 'harry'\n});\n")),(0,a.kt)("p",null,"\u83b7\u53d6\u5143\u6570\u636e\u76f8\u5bf9\u9ebb\u70e6\u4e00\u4e9b\u3002"),(0,a.kt)("p",null,"\u666e\u901a\u4e00\u5143\u8c03\u7528\uff08UnaryCall\uff09\u83b7\u53d6\u5143\u6570\u636e\u9700\u8981\u4f7f\u7528 ",(0,a.kt)("inlineCode",{parentName:"p"},"sendMessageWithCallback")," \u65b9\u6cd5\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"const call = service.sayHello().sendMessageWithCallback({\n  name: 'zhangting'\n}, (err) => {\n  if (err) {\n    reject(err);\n  }\n});\ncall.on('metadata', (meta) => {\n  // output meta\n});\n")),(0,a.kt)("p",null,"\u5176\u4ed6\u6d41\u5f0f\u670d\u52a1\uff0c\u53ef\u4ee5\u901a\u8fc7 ",(0,a.kt)("inlineCode",{parentName:"p"},"getCall()")," \u65b9\u6cd5\u83b7\u53d6\u539f\u59cb\u5ba2\u6237\u7aef\u6d41\u5bf9\u8c61\uff0c\u4ece\u800c\u76f4\u63a5\u8ba2\u9605\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// \u83b7\u53d6\u670d\u52a1\uff0c\u6ce8\u610f\uff0c\u8fd9\u91cc\u6ca1\u6709 await\nconst call = service.addMany().getCall();\ncall.on('metadata', (meta) => {\n  // output meta\n});\n")),(0,a.kt)("h2",{id:"\u8d85\u65f6\u5904\u7406"},"\u8d85\u65f6\u5904\u7406"),(0,a.kt)("p",null,"\u6211\u4eec\u53ef\u4ee5\u5728\u8c03\u7528\u670d\u52a1\u65f6\u4f20\u9012\u53c2\u6570\uff0c\u5355\u4f4d\u6beb\u79d2\u3002"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"const result = await service.sayHello({\n  timeout: 5000\n}).sendMessage({\n  name: 'harry'\n});\n")))}c.isMDXComponent=!0}}]);