"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[619],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>h});var o=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},r=Object.keys(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=o.createContext({}),p=function(e){var t=o.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},c=function(e){var t=p(e.components);return o.createElement(l.Provider,{value:t},e.children)},d="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},u=o.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,l=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),d=p(n),u=a,h=d["".concat(l,".").concat(u)]||d[u]||m[u]||r;return n?o.createElement(h,s(s({ref:t},c),{},{components:n})):o.createElement(h,s({ref:t},c))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,s=new Array(r);s[0]=u;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i[d]="string"==typeof e?e:a,s[1]=i;for(var p=2;p<r;p++)s[p]=n[p];return o.createElement.apply(null,s)}return o.createElement.apply(null,n)}u.displayName="MDXCreateElement"},88963:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>m,frontMatter:()=>r,metadata:()=>i,toc:()=>p});var o=n(87462),a=(n(67294),n(3905));const r={},s="Tracer",i={unversionedId:"extensions/otel",id:"extensions/otel",title:"Tracer",description:"Midway adopts the latest open-telemetry scheme in the community. Its predecessor is a well-known OpenTracing and OpenCensus specification. At this stage, Midway is also an incubation project of CNCF. Many well-known large companies in the community such as Amazon,Dynatrace,Microsoft,Google,Datadog,Splunk, etc. have used it.",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/extensions/otel.md",sourceDirName:"extensions",slug:"/extensions/otel",permalink:"/en/docs/extensions/otel",draft:!1,editUrl:"https://github.com/midwayjs/midway/tree/main/site/docs/extensions/otel.md",tags:[],version:"current",frontMatter:{},sidebar:"component",previous:{title:"MQTT",permalink:"/en/docs/extensions/mqtt"},next:{title:"Code dyeing",permalink:"/en/docs/extensions/code_dye"}},l={},p=[{value:"Instructions for Use",id:"instructions-for-use",level:2},{value:"Installation base dependency",id:"installation-base-dependency",level:2},{value:"Enable open-telemetry",id:"enable-open-telemetry",level:2},{value:"Use bootstrap deployment",id:"use-bootstrap-deployment",level:3},{value:"Use egg-scripts deployment",id:"use-egg-scripts-deployment",level:3},{value:"Development and debugging portal",id:"development-and-debugging-portal",level:3},{value:"Common concepts",id:"common-concepts",level:2},{value:"API",id:"api",level:3},{value:"SDK",id:"sdk",level:3},{value:"Instrumentations",id:"instrumentations",level:3},{value:"Exporter",id:"exporter",level:3},{value:"Example",id:"example",level:2},{value:"Add tripartite instrumentation",id:"add-tripartite-instrumentation",level:3},{value:"Add Jaeger Exporter",id:"add-jaeger-exporter",level:3},{value:"Alibaba Cloud ARMS",id:"alibaba-cloud-arms",level:3},{value:"Framework capability support",id:"framework-capability-support",level:2},{value:"ctx.traceId",id:"ctxtraceid",level:3},{value:"Decorator support",id:"decorator-support",level:3}],c={toc:p},d="wrapper";function m(e){let{components:t,...n}=e;return(0,a.kt)(d,(0,o.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"tracer"},"Tracer"),(0,a.kt)("p",null,"Midway adopts the latest ",(0,a.kt)("a",{parentName:"p",href:"https://opentelemetry.io/"},"open-telemetry")," scheme in the community. Its predecessor is a well-known OpenTracing and OpenCensus specification. At this stage, Midway is also an incubation project of CNCF. Many well-known large companies in the community such as Amazon,Dynatrace,Microsoft,Google,Datadog,Splunk, etc. have used it."),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://opentelemetry.io/"},"Open-telemetry")," provides a general Node.js access solution, which receives, processes, and exports data in a vendor-independent manner, and supports sending observable data to one or more open source or commercial collection terminals (such as Alibaba Cloud SLS,Jaeger,Prometheus,Fluent Bit, etc.)."),(0,a.kt)("p",null,"Midway provides a Node.js scheme to access ",(0,a.kt)("a",{parentName:"p",href:"https://opentelemetry.io/"},"open-telemetry")," and some simple API."),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"The Tracing part of ",(0,a.kt)("a",{parentName:"p",href:"https://opentelemetry.io/"},"open-telemetry")," is currently Release 1.0.0 for Node.js SDK, which can be used in production. The Metrics part has not been officially released, and we are still following up (encoding).")),(0,a.kt)("h2",{id:"instructions-for-use"},"Instructions for Use"),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://opentelemetry.io/"},"Open-telemetry")," the Async_Hooks stable API implementation based on Node.js. after our tests, the performance impact of the latest Node.js v14/v16 has been very small and can be used in production. although it can be used in the case of v12, there is still a big loss in performance. please use it in the version of Node.js >= v14 as much as possible."),(0,a.kt)("h2",{id:"installation-base-dependency"},"Installation base dependency"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"# Node.js api abstraction\n$ npm install --save @opentelemetry/api\n\nApi implementation of# Node.js\n$ npm install --save @opentelemetry/sdk-node\n\n# Common Node.js Module Buried Point Implementation\n$ npm install --save @opentelemetry/auto-instrumentations-node\n\n# jaeger output\n$ npm install --save @opentelemetry/exporter-jaeger\n")),(0,a.kt)("p",null,"The above packages are all official packages of ",(0,a.kt)("a",{parentName:"p",href:"https://opentelemetry.io/"},"open-telemetry"),"."),(0,a.kt)("h2",{id:"enable-open-telemetry"},"Enable open-telemetry"),(0,a.kt)("p",null,"Please add the ",(0,a.kt)("a",{parentName:"p",href:"https://opentelemetry.io/"},"open-telemetry")," module to the beginning of the code as much as possible (earlier than the framework), so we have different ways to add it in different scenarios."),(0,a.kt)("h3",{id:"use-bootstrap-deployment"},"Use bootstrap deployment"),(0,a.kt)("p",null,"If you use ",(0,a.kt)("inlineCode",{parentName:"p"},"bootstrap.js")," deployment, you can add it to the top of the ",(0,a.kt)("inlineCode",{parentName:"p"},"bootstrap.js"),". The sample code is as follows."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"const process = require('process');\nconst { NodeSDK, node, resources } = require('@opentelemetry/sdk-node');\nconst { getNodeAutoInstrumentations } = require('@opentelemetry/auto-instrumentations-node');\nconst { SemanticResourceAttributes } = require('@opentelemetry/semantic-conventions')\nconst { JaegerExporter } = require('@opentelemetry/exporter-jaeger')\n\n// Midway startup file\nconst { Bootstrap } = require('@midwayjs/bootstrap');\n\n// https://www.npmjs.com/package/@opentelemetry/exporter-jaeger\nconst tracerAgentHost = process.env['TRACER_AGENT_HOST'] || '127.0.0.1'\nconst jaegerExporter = new JaegerExporter({\n  host: tracerAgentHost\n});\n\n// Initialize an open-telemetry SDK\nconst sdk = new NodeSDK({\n  // Set the tracking service name\n  resource: new resources.Resource({\n    [SemanticResourceAttributes.SERVICE_NAME]: 'my-app',\n  }),\n  // Configure the current export method. For example, one output to the console is configured here, or other Exporter can be configured, such as Jaeger.\n  traceExporter: new node.ConsoleSpanExporter(),\n  // configure the current export as jaeger\n  // traceExporter: jaegerExporter\n\n  // Some monitoring modules provided by default are configured here, such as http module, etc.\n  // If the initialization time is very long, you can log off this line and configure the required instrumentation entries separately.\n  instrumentations: [getNodeAutoInstrumentations()]\n});\n\n// Initialize the SDK and start the Midway framework after successful startup.\nsdk.start()\n\n// When the process is closed, data collection is closed at the same time\nprocess.on('SIGTERM', () => {\n  sdk.shutdown()\n    .then(() => console.log('Tracing terminated'))\n    .catch((error) => console.log('Error terminating tracing', error))\n    .finally(() => process.exit(0));\n});\n\nBootstrap\n  .configure(/**/)\n  .run();\n")),(0,a.kt)("h3",{id:"use-egg-scripts-deployment"},"Use egg-scripts deployment"),(0,a.kt)("p",null,"Egg-scripts Since no portal deployment is provided, additional files must be loaded in the form of ",(0,a.kt)("inlineCode",{parentName:"p"},"-require"),"."),(0,a.kt)("p",null,"Add a ",(0,a.kt)("inlineCode",{parentName:"p"},"tel.js")," file to the root directory. The content is as follows."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"const process = require('process');\nconst { NodeSDK, node, resources } = require('@opentelemetry/sdk-node');\nconst { getNodeAutoInstrumentations } = require('@opentelemetry/auto-instrumentations-node');\n\n// Initialize an open-telemetry SDK\nconst sdk = new NodeSDK({\n  // Configure the current export method. For example, one output to the console is configured here, or other Exporter can be configured, such as Jaeger.\n  traceExporter: new node.ConsoleSpanExporter(),\n  // Some monitoring modules provided by default are configured here, such as http module, etc.\n  instrumentations: [getNodeAutoInstrumentations()]\n});\n\n// Initialize SDK\nsdk.start()\n\n\n// When the process is closed, data collection is closed at the same time\nprocess.on('SIGTERM', () => {\n  sdk.shutdown()\n    .then(() => console.log('Tracing terminated'))\n    .catch((error) => console.log('Error terminating tracing', error))\n    .finally(() => process.exit(0));\n});\n")),(0,a.kt)("p",null,"Modify the startup command in the ",(0,a.kt)("inlineCode",{parentName:"p"},"package.json"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'{\n  // ...\n  "scripts": {\n    "start": "egg-scripts start --daemon --title=**** --framework=@midwayjs/web --require=./otel.js ",\n  },\n}\n')),(0,a.kt)("h3",{id:"development-and-debugging-portal"},"Development and debugging portal"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"midway-bin")," uses the ",(0,a.kt)("inlineCode",{parentName:"p"},"-- entryFile")," parameter to specify the entry file"),(0,a.kt)("p",null,"For example, the ",(0,a.kt)("inlineCode",{parentName:"p"},"package.json")," file"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "scripts": {\n    "start": "cross-env NODE_ENV=local midway-bin dev --ts --entryFile=bootstrap.js"\n  }\n}\n')),(0,a.kt)("h2",{id:"common-concepts"},"Common concepts"),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://opentelemetry.io/"},"Open-telemetry")," provides some abstract packaging, packaging the whole process of monitoring into several steps, each step can be customized configuration, and there are also some terms that users do not understand. Let's explain them below."),(0,a.kt)("p",null,"Please refer to the ",(0,a.kt)("a",{parentName:"p",href:"https://opentelemetry.io/docs/concepts/"},"Concepts")," for complete English concepts."),(0,a.kt)("h3",{id:"api"},"API"),(0,a.kt)("p",null,"A set of API abstractions used to generate and associate data types and operations of Tracing, Metrics, and Logs record data. The specific expression is the package ",(0,a.kt)("inlineCode",{parentName:"p"},"@opentelemetry/api"),", which contains some interfaces and empty implementations."),(0,a.kt)("h3",{id:"sdk"},"SDK"),(0,a.kt)("p",null,"The language-specific implementation of the API, such as the implementation of Node.js (",(0,a.kt)("inlineCode",{parentName:"p"},"@opentelemetry/sdk-node")," ), and the implementation of the collection SDK of other monitoring platforms."),(0,a.kt)("h3",{id:"instrumentations"},"Instrumentations"),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://opentelemetry.io/"},"Open-telemetry")," provides shim codes of some common libraries. It uses hooks or monkey-patching methods to intercept methods, automatically saves link data when specific methods are called, and supports http,gRPC , redis,mysql and other modules. Users can use them directly by configuring them."),(0,a.kt)("p",null,"For example, the ",(0,a.kt)("inlineCode",{parentName:"p"},"@opentelemetry/auto-instrumentations-node")," introduced in the above example is a instrumentations collection package that has already encapsulated common libraries by default, including most of the libraries that will be used. For specific dependencies, please refer to ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/open-telemetry/opentelemetry-js-contrib/blob/main/metapackages/auto-instrumentations-node/package.json"},"Github"),"."),(0,a.kt)("h3",{id:"exporter"},"Exporter"),(0,a.kt)("p",null,"Sends the received link data to a specific implementation, such as Jaeger,zipkin, etc."),(0,a.kt)("h2",{id:"example"},"Example"),(0,a.kt)("h3",{id:"add-tripartite-instrumentation"},"Add tripartite instrumentation"),(0,a.kt)("p",null,"When the SDK is initialized, add it to the ",(0,a.kt)("inlineCode",{parentName:"p"},"instrumentations")," array."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"const { RedisInstrumentation } = require('@opentelemetry/instrumentation-redis');\n// ...\n\n// Initialize an open-telemetry SDK\nconst sdk = new NodeSDK({\n  // ...\n\n  // This is only an added example. If auto-instrumentations-node is used, the following instrumentation are already included\n  instrumentations: [\n    new RedisInstrumentation()\n  ]\n});\n")),(0,a.kt)("h3",{id:"add-jaeger-exporter"},"Add Jaeger Exporter"),(0,a.kt)("p",null,"Here, Jaeger Exporter is taken as an example, and other Exporter are similar."),(0,a.kt)("p",null,"Add dependencies first."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"$ npm install --save @opentelemetry/exporter-jaeger @opentelemetry/propagator-jaeger\n")),(0,a.kt)("p",null,"Configure in the SDK."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"const { JaegerExporter } = require('@opentelemetry/exporter-jaeger');\nconst { JaegerPropagator } = require('@opentelemetry/propagator-jaeger');\n// ...\n\nconst exporter = new JaegerExporter({\n  tags: [], // optional\n  // You can use the default UDPSender\n  host: 'localhost', // optional\n  port: 6832, // optional\n  // OR you can use the HTTPSender as follows\n  // endpoint: 'http://localhost:14268/api/traces',\n  maxPacketSize: 65000 // optional\n});\n\n// Initialize an open-telemetry SDK\nconst sdk = new NodeSDK({\n  traceExporter: exporter\n  textMapPropagator: new JaegerPropagator()\n  // ...\n});\n")),(0,a.kt)("p",null,"For specific parameters, please refer:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://github.com/open-telemetry/opentelemetry-js/blob/main/packages/opentelemetry-exporter-jaeger/README.md"},"opentelemetry-exporter-jaeger")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://github.com/open-telemetry/opentelemetry-js/blob/main/packages/opentelemetry-propagator-jaeger/README.md"},"opentelemetry-propagator-jaeger"))),(0,a.kt)("h3",{id:"alibaba-cloud-arms"},"Alibaba Cloud ARMS"),(0,a.kt)("p",null,"Alibaba Cloud Application Real-Time Monitoring Service (",(0,a.kt)("a",{parentName:"p",href:"https://www.aliyun.com/product/arms/"},"ARMS"),") already supports indicators in open-telemetry format, and provides an sdk for access."),(0,a.kt)("p",null,"First, ",(0,a.kt)("inlineCode",{parentName:"p"},"opentelemetry-arms")," is installed."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"# arms sdk\n$ npm install --save opentelemetry-arms\n")),(0,a.kt)("p",null,"Then, add the environment variable and ",(0,a.kt)("inlineCode",{parentName:"p"},"-R")," parameters at startup."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"$SERVICE_NAME=nodejs-opentelemetry-express AUTHENTICATION=**** ENDPOINT=grpc://**** node -r opentelemetry-arms bootstrap.js\n")),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("ul",{parentName:"admonition"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("ol",{parentName:"li"},(0,a.kt)("li",{parentName:"ol"},"There is no need to add code to ",(0,a.kt)("inlineCode",{parentName:"li"},"bootstrap.js")," for access in this way."))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("ol",{parentName:"li",start:2},(0,a.kt)("li",{parentName:"ol"},"The default sdk only provides link support for http/express/koa modules and does not include other instrumentations. If necessary, you can copy the source code to ",(0,a.kt)("inlineCode",{parentName:"li"},"bootstrap.js")," for customization."))))),(0,a.kt)("h2",{id:"framework-capability-support"},"Framework capability support"),(0,a.kt)("p",null,"Note that the component only wraps the interface of otel, if you don\u2019t need the following interface to use, you don\u2019t need to install this component"),(0,a.kt)("p",null,"Install dependencies first."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"$ npm i @midwayjs/otel@3 --save\n")),(0,a.kt)("p",null,"Enable the ",(0,a.kt)("inlineCode",{parentName:"p"},"otel")," component."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Configuration } from '@midwayjs/core';\nimport * as otel from '@midwayjs/otel';\n\n@Configuration({\n   imports: [\n     //...\n     otel\n   ]\n})\nexport class MainConfiguration {\n}\n")),(0,a.kt)("h3",{id:"ctxtraceid"},"ctx.traceId"),(0,a.kt)("p",null,"The component provides ",(0,a.kt)("inlineCode",{parentName:"p"},"ctx.traceId")," field."),(0,a.kt)("p",null,"You can get it under supported components (egg/koa)."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"ctx.traceId => *****\n")),(0,a.kt)("h3",{id:"decorator-support"},"Decorator support"),(0,a.kt)("p",null,"Midway adds a decorator to add link nodes to the needs of the user side."),(0,a.kt)("p",null,"The Otel component provides an @Trace decorator that can be added to the method."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"export class UserService {\n\n  @Trace('user.get')\n  async getUser() {\n    // ...\n  }\n}\n")),(0,a.kt)("p",null,"The decorator needs to pass in a node name, so that the link will automatically add a link node of the method and record the execution time. The method execution succeeded or failed."))}m.isMDXComponent=!0}}]);