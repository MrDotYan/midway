"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[10919],{3905:(e,t,n)=>{n.d(t,{Zo:()=>m,kt:()=>h});var o=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},i=Object.keys(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=o.createContext({}),p=function(e){var t=o.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},m=function(e){var t=p(e.components);return o.createElement(s.Provider,{value:t},e.children)},d="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},u=o.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,s=e.parentName,m=l(e,["components","mdxType","originalType","parentName"]),d=p(n),u=a,h=d["".concat(s,".").concat(u)]||d[u]||c[u]||i;return n?o.createElement(h,r(r({ref:t},m),{},{components:n})):o.createElement(h,r({ref:t},m))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,r=new Array(i);r[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[d]="string"==typeof e?e:a,r[1]=l;for(var p=2;p<i;p++)r[p]=n[p];return o.createElement.apply(null,r)}return o.createElement.apply(null,n)}u.displayName="MDXCreateElement"},82852:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>r,default:()=>c,frontMatter:()=>i,metadata:()=>l,toc:()=>p});var o=n(87462),a=(n(67294),n(3905));const i={},r="TypeORM",l={unversionedId:"legacy/orm",id:"legacy/orm",title:"TypeORM",description:"This document is obsolete from v3.4.0.",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/legacy/orm.md",sourceDirName:"legacy",slug:"/legacy/orm",permalink:"/en/docs/legacy/orm",draft:!1,editUrl:"https://github.com/midwayjs/midway/tree/main/site/docs/legacy/orm.md",tags:[],version:"current",frontMatter:{},sidebar:"component",previous:{title:"Sequelize",permalink:"/en/docs/legacy/sequelize"},next:{title:"Task scheduling",permalink:"/en/docs/legacy/task"}},s={},p=[{value:"Installation Components",id:"installation-components",level:2},{value:"Enable component",id:"enable-component",level:2},{value:"Install database Driver",id:"install-database-driver",level:2},{value:"Simple directory structure",id:"simple-directory-structure",level:2},{value:"Getting Started",id:"getting-started",level:2},{value:"1. Create Model",id:"1-create-model",level:3},{value:"2. Add a solid model decorator",id:"2-add-a-solid-model-decorator",level:3},{value:"3. Add database columns",id:"3-add-database-columns",level:3},{value:"4. Create a primary key column",id:"4-create-a-primary-key-column",level:3},{value:"5. Create a self-increasing primary key column",id:"5-create-a-self-increasing-primary-key-column",level:3},{value:"6. Column data type",id:"6-column-data-type",level:3},{value:"7. Configure connection information",id:"7-configure-connection-information",level:3},{value:"8. Use Model to insert database data",id:"8-use-model-to-insert-database-data",level:3},{value:"9. Query Data",id:"9-query-data",level:3},{value:"10. Update the database",id:"10-update-the-database",level:3},{value:"11. Delete data",id:"11-delete-data",level:3},{value:"12. Create a one-to-one association",id:"12-create-a-one-to-one-association",level:3},{value:"13. Reverse relation mapping",id:"13-reverse-relation-mapping",level:3},{value:"14. Load objects and their dependencies",id:"14-load-objects-and-their-dependencies",level:3},{value:"15. Use cascade operations to automatically save associated objects",id:"15-use-cascade-operations-to-automatically-save-associated-objects",level:3},{value:"16. Create many-to-one/one-to-many associations",id:"16-create-many-to-oneone-to-many-associations",level:3},{value:"17. Create many-to-many associations",id:"17-create-many-to-many-associations",level:3},{value:"18. Use QueryBuilder",id:"18-use-querybuilder",level:3},{value:"19. Event Subscriber",id:"19-event-subscriber",level:3},{value:"20. OrmConnectionHook",id:"20-ormconnectionhook",level:3},{value:"Advanced features",id:"advanced-features",level:2},{value:"Multi-database support",id:"multi-database-support",level:3},{value:"Get connection pool",id:"get-connection-pool",level:3},{value:"Hooks scenario support",id:"hooks-scenario-support",level:3},{value:"About Table Structure Synchronization",id:"about-table-structure-synchronization",level:3},{value:"Frequently Asked Questions",id:"frequently-asked-questions",level:2},{value:"Handshake inactivity timeout",id:"handshake-inactivity-timeout",level:3},{value:"About the current time zone display of mysql time column",id:"about-the-current-time-zone-display-of-mysql-time-column",level:3},{value:"Default values for time columns",id:"default-values-for-time-columns",level:3},{value:"Install mysql and mysql2 at the same time",id:"install-mysql-and-mysql2-at-the-same-time",level:3}],m={toc:p},d="wrapper";function c(e){let{components:t,...n}=e;return(0,a.kt)(d,(0,o.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"typeorm"},"TypeORM"),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"This document is obsolete from v3.4.0.")),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://github.com/typeorm/typeorm"},"TypeORM")," is the most mature object relation mapper (",(0,a.kt)("inlineCode",{parentName:"p"},"ORM"),") in the existing community of ",(0,a.kt)("inlineCode",{parentName:"p"},"node.js"),". Midway and TypeORM match to make development easier."),(0,a.kt)("p",null,"Related information:"),(0,a.kt)("table",null,(0,a.kt)("thead",{parentName:"table"},(0,a.kt)("tr",{parentName:"thead"},(0,a.kt)("th",{parentName:"tr",align:null},"Description"),(0,a.kt)("th",{parentName:"tr",align:null}))),(0,a.kt)("tbody",{parentName:"table"},(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Can be used for standard projects"),(0,a.kt)("td",{parentName:"tr",align:null},"\u2705")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Can be used for Serverless"),(0,a.kt)("td",{parentName:"tr",align:null},"\u2705")),(0,a.kt)("tr",{parentName:"tbody"},(0,a.kt)("td",{parentName:"tr",align:null},"Can be used for integration"),(0,a.kt)("td",{parentName:"tr",align:null},"\u2705")))),(0,a.kt)("h2",{id:"installation-components"},"Installation Components"),(0,a.kt)("p",null,"Install orm components to provide database ORM capabilities."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"$ npm i @midwayjs/orm@3 typeorm --save\n")),(0,a.kt)("p",null,"Or reinstall the following dependencies in ",(0,a.kt)("inlineCode",{parentName:"p"},"package.json"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "dependencies": {\n    "@midwayjs/orm": "^3.0.0",\n    "typeorm": "~0.3.0 ",\n    // ...\n  },\n  "devDependencies": {\n    // ...\n  }\n}\n')),(0,a.kt)("h2",{id:"enable-component"},"Enable component"),(0,a.kt)("p",null,"Introducing orm components in ",(0,a.kt)("inlineCode",{parentName:"p"},"src/configuration.ts"),", an example is as follows."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// configuration.ts\nimport { Configuration } from '@midwayjs/core';\nimport * as orm from '@midwayjs/orm';\nimport { join } from 'path';\n\n@Configuration({\n  imports: [\n    // ...\n    orm // load orm components\n  ],\n  importConfigs: [\n    join(__dirname, './config')\n  ]\n})\nexport class ContainerConfiguratin {\n\n}\n")),(0,a.kt)("h2",{id:"install-database-driver"},"Install database Driver"),(0,a.kt)("p",null,"The commonly used database drivers are as follows. Select the database type to install the corresponding connection:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"# for MySQL or MariaDB, you can also use mysql2 instead\nnpm install mysql --save\nnpm install mysql2 --save\n\n# for PostgreSQL or CockroachDB\nnpm install pg --save\n\n# for SQLite\nnpm install sqlite3 --save\n\n# for Microsoft SQL Server\nnpm install mssql --save\n\n# for SQL .js\nnpm install SQL .js --save\n\n# for Oracle\nnpm install oracledb --save\n\n# for MongoDB(experimental)\nnpm install mongodb --save\n")),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"To make the",(0,a.kt)("strong",{parentName:"p"}," Oracle driver work"),", you need to follow the installation instructions from ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/oracle/node-oracledb"},"their")," site.")),(0,a.kt)("h2",{id:"simple-directory-structure"},"Simple directory structure"),(0,a.kt)("p",null,"Let's take a simple project as an example. Please refer to other structures yourself."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"MyProject\n\u251c\u2500\u2500 src                                         // TS root directory\n\u2502   \u251c\u2500\u2500 config\n\u2502   \u2502   \u2514\u2500\u2500 config.default.ts       // Application Profile\n\u2502   \u251c\u2500\u2500 entity                                  // entity (database Model) directory\n\u2502   \u2502   \u2514\u2500\u2500 photo.ts                      // entity file\n\u2502   \u2502   \u2514\u2500\u2500 photoMetadata.ts\n\u2502   \u251c\u2500\u2500 configuration.ts                // Midway configuration file\n\u2502   \u2514\u2500\u2500 service                                 // Other service directory\n\u251c\u2500\u2500 .gitignore\n\u251c\u2500\u2500 package.json\n\u251c\u2500\u2500 README.md\n\u2514\u2500\u2500 tsconfig.json\n")),(0,a.kt)("p",null,"Here, our database entities are mainly located in the ",(0,a.kt)("inlineCode",{parentName:"p"},"entity")," directory (non-mandatory). This is a simple convention."),(0,a.kt)("h2",{id:"getting-started"},"Getting Started"),(0,a.kt)("p",null,"Next, we will take mysql as an example."),(0,a.kt)("h3",{id:"1-create-model"},"1. Create Model"),(0,a.kt)("p",null,"We associate the model with the database. The model in the application is the database table. In TypeORM, the model is bound to the entity. Each Entity file is a Model and an Entity."),(0,a.kt)("p",null,"In the example, you need an entity. Let's take ",(0,a.kt)("inlineCode",{parentName:"p"},"photo")," as an example. Create an entity directory and add the entity file ",(0,a.kt)("inlineCode",{parentName:"p"},"photo.ts")," to the entity directory. A simple entity is as follows."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// entity/photo.ts\nexport class Photo {\n  id: number;\n  name: string;\n  description: string;\n  filename: string;\n  views: number;\n  isPublished: boolean;\n}\n")),(0,a.kt)("p",null,"Note that each attribute of the entity file here is actually one-to-one corresponding to the database table. Based on the existing database table, we add content up."),(0,a.kt)("h3",{id:"2-add-a-solid-model-decorator"},"2. Add a solid model decorator"),(0,a.kt)("p",null,"We use ",(0,a.kt)("inlineCode",{parentName:"p"},"EntityModel")," to define an entity model class."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// entity/photo.ts\nimport { EntityModel } from '@midwayjs/orm';\n\n@EntityModel('photo')\nexport class Photo {\n  id: number;\n  name: string;\n  description: string;\n  filename: string;\n  views: number;\n  isPublished: boolean;\n}\n")),(0,a.kt)("admonition",{type:"caution"},(0,a.kt)("p",{parentName:"admonition"},"Note that the EntityModel here is a special decorator packaged by midway, in order to better combine with midway. Please do not directly use Entity in the typeorm.")),(0,a.kt)("p",null,"If the table name is different from the current entity name, you can specify it in the parameter."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// entity/photo.ts\nimport { EntityModel } from '@midwayjs/orm';\n\n@EntityModel('photo_table_name')\nexport class Photo {\n  id: number;\n  name: string;\n  description: string;\n  filename: string;\n  views: number;\n  isPublished: boolean;\n}\n")),(0,a.kt)("p",null,"These entity columns can also be generated using ",(0,a.kt)("a",{parentName:"p",href:"/docs/tool/typeorm_generator"},"typeorm_generator")," tools."),(0,a.kt)("h3",{id:"3-add-database-columns"},"3. Add database columns"),(0,a.kt)("p",null,"Attributes are decorated with the ",(0,a.kt)("inlineCode",{parentName:"p"},"@Column")," decorator provided by typeorm, and each attribute corresponds to a column."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// entity/photo.ts\nimport { EntityModel } from '@midwayjs/orm';\nimport { Column } from 'typeorm';\n\n@EntityModel()\nexport class Photo {\n\n  @Column()\n  id: number;\n\n  @Column()\n  name: string;\n\n  @Column()\n  description: string;\n\n  @Column()\n  filename: string;\n\n  @Column()\n  views: number;\n\n  @Column()\n  isPublished: boolean;\n\n}\n")),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"id"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"name"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"description"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"filename"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"views"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"isPublished")," columns are added to the ",(0,a.kt)("inlineCode",{parentName:"p"},"photo")," table. The column types in the database are inferred according to the attribute types you use, for example, number will be converted to integers, strings will be converted to varchar, boolean values will be converted to bool, and so on. However, you can use any column type supported by the database by explicitly specifying the column type in the ",(0,a.kt)("inlineCode",{parentName:"p"},"@Column")," decorator."),(0,a.kt)("p",null,"We generated a database table with columns, but there is one thing left. Each database table must have a column with a primary key."),(0,a.kt)("p",null,"Database columns include more column options (ColumnOptions), such as modifying column names, specifying column types, and column lengths. For more options, see the ","[official documentation]","(",(0,a.kt)("a",{parentName:"p",href:"https://github.com/typeorm/typeorm/blob/master/docs/zh_CN/entities.md#%E5%88%25"},"https://github.com/typeorm/typeorm/blob/master/docs/zh_CN/entities.md#%E5%88%")," 97% E9%80% 89% E9%A1%B9)."),(0,a.kt)("h3",{id:"4-create-a-primary-key-column"},"4. Create a primary key column"),(0,a.kt)("p",null,"Each entity must have at least one primary key column. To make a column a primary key, you need to use the ",(0,a.kt)("inlineCode",{parentName:"p"},"@PrimaryColumn")," decorator."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// entity/photo.ts\nimport { EntityModel } from '@midwayjs/orm';\nimport { Column, PrimaryColumn } from 'typeorm';\n\n@EntityModel()\nexport class Photo {\n\n  @PrimaryColumn()\n  id: number;\n\n  @Column()\n  name: string;\n\n  @Column()\n  description: string;\n\n  @Column()\n  filename: string;\n\n  @Column()\n  views: number;\n\n  @Column()\n  isPublished: boolean;\n\n}\n")),(0,a.kt)("h3",{id:"5-create-a-self-increasing-primary-key-column"},"5. Create a self-increasing primary key column"),(0,a.kt)("p",null,"Now, if you want to set the self-increasing id column, you need to change the ",(0,a.kt)("inlineCode",{parentName:"p"},"@PrimaryColumn")," decorator to the ",(0,a.kt)("inlineCode",{parentName:"p"},"@PrimaryGeneratedColumn")," decorator:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// entity/photo.ts\nimport { EntityModel } from '@midwayjs/orm';\nimport { Column, PrimaryGeneratedColumn } from 'typeorm';\n\n@EntityModel()\nexport class Photo {\n\n  @PrimaryGeneratedColumn()\n  id: number;\n\n  @Column()\n  name: string;\n\n  @Column()\n  description: string;\n\n  @Column()\n  filename: string;\n\n  @Column()\n  views: number;\n\n  @Column()\n  isPublished: boolean;\n\n}\n")),(0,a.kt)("h3",{id:"6-column-data-type"},"6. Column data type"),(0,a.kt)("p",null,"Next, let's adjust the data type. By default, strings map to types similar to ",(0,a.kt)("inlineCode",{parentName:"p"},"varchar(255)")," (depending on the database type).  Number is mapped to an integer-like type (depending on the database type). However, we do not want all columns to be limited to varchars or integers. Some changes can be made at this time."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// entity/photo.ts\nimport { EntityModel } from '@midwayjs/orm';\nimport { Column, PrimaryGeneratedColumn } from 'typeorm';\n\n@EntityModel()\nexport class Photo {\n\n  @PrimaryGeneratedColumn()\n  id: number;\n\n  @Column({\n    length: 100\n  })\n  name: string;\n\n  @Column('text')\n  description: string;\n\n  @Column()\n  filename: string;\n\n  @Column(\"double\")\n  views: number;\n\n  @Column()\n  isPublished: boolean;\n\n}\n")),(0,a.kt)("p",null,"Example, different column names"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"@Column({\n  length: 100\n  name: 'custom_name'\n})\nname: string;\n")),(0,a.kt)("p",null,"In addition, there are several special column types that can be used:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@CreateDateColumn")," is a special column that automatically inserts dates for entities."),(0,a.kt)("li",{parentName:"ul"},"The ",(0,a.kt)("inlineCode",{parentName:"li"},"@UpdateDateColumn")," is a special column that automatically updates the entity date each time the entity manager or save of the repository is called."),(0,a.kt)("li",{parentName:"ul"},"The ",(0,a.kt)("inlineCode",{parentName:"li"},"@VersionColumn")," is a special column that automatically increases the entity version (increment number) each time the entity manager or save of the repository is called."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"@DeleteDateColumn")," is a special column that automatically sets the deletion time of the entity when soft-delete is called.")),(0,a.kt)("p",null,"The column type is database-specific. You can set any column type supported by the database. For more information about supported column types, see ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/typeorm/typeorm/blob/master/docs/entities.md#column-types"},"here"),"."),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("p",{parentName:"admonition"},(0,a.kt)("inlineCode",{parentName:"p"},"CreateDateColumn")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"UpdateDateColumn")," rely on the insertion date function of creating the default data on the column when the table structure is synchronized for the first time. If the table is created by yourself, you need to add the default data to the column.")),(0,a.kt)("h3",{id:"7-configure-connection-information"},"7. Configure connection information"),(0,a.kt)("p",null,"Please refer to the ",(0,a.kt)("a",{parentName:"p",href:"/docs/env_config"},"Configuration")," chapter to add configuration files."),(0,a.kt)("p",null,"Then configure the database connection information in ",(0,a.kt)("inlineCode",{parentName:"p"},"config.default.ts"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default.ts\nexport default {\n  // ...\n  orm: {\n    /**\n     * Single database instance\n     */\n    type: 'mysql',\n    host: '',\n    port: 3306\n    username: '',\n    password: '',\n    database: undefined\n    synchronize: false, // If the table does not exist for the first time, you can write true if you need synchronization.\n    logging: false\n  },\n}\n")),(0,a.kt)("p",null,"utc time is stored by default (recommended)."),(0,a.kt)("p",null,"Time zone can also be configured (not recommended)"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default.ts\nexport default {\n  // ...\n  orm: {\n    // ...\n    timezone: '+08:00',\n  },\n}\n")),(0,a.kt)("p",null,"You can use other database types for this ",(0,a.kt)("inlineCode",{parentName:"p"},"type")," field, including ",(0,a.kt)("inlineCode",{parentName:"p"},"mysql"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"mariadb"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"postgres"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"cockroachdb"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"sqlite"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"mssql"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"oracle"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"cordova"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"nativescript"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"react-native"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"expo"),", or ",(0,a.kt)("inlineCode",{parentName:"p"},"mongodb")),(0,a.kt)("p",null,"For example, sqlite only needs the following information."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default.ts\nexport default {\n  // ...\n  orm: {\n    type: 'sqlite',\n    database: path.join(__dirname, '../../test.sqlite')\n    synchronize: true\n    logging: true\n  },\n}\n")),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"Note: synchronize fields are used to synchronize table structures. It is not safe to use ",(0,a.kt)("inlineCode",{parentName:"p"},"synchronize: true")," for production mode synchronization. Please set this field to false after going online.")),(0,a.kt)("h3",{id:"8-use-model-to-insert-database-data"},"8. Use Model to insert database data"),(0,a.kt)("p",null,"In common Midway files, use the ",(0,a.kt)("inlineCode",{parentName:"p"},"@InjectEntityModel")," decorator to inject our configured Model. All we need to do is:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("ol",{parentName:"li"},(0,a.kt)("li",{parentName:"ol"},"Create entity objects"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("ol",{parentName:"li",start:2},(0,a.kt)("li",{parentName:"ol"},"Execute the ",(0,a.kt)("inlineCode",{parentName:"li"},"save()"))))),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Provide } from '@midwayjs/core';\nimport { InjectEntityModel } from '@midwayjs/orm';\nimport { Photo } from '../entity/photo';\nimport { Repository } from 'typeorm';\n\n@Provide()\nexport class PhotoService {\n\n  @InjectEntityModel(Photo)\n  photoModel: Repository<Photo>;\n\n  // save\n  async savePhoto() {\n    // create a entity object\n    let photo = new Photo();\n    photo.name = 'Me and Bears';\n    photo.description = 'I am near polar bears';\n    photo.filename = 'photo-with-bears.jpg';\n    photo.views = 1;\n    photo.isPublished = true;\n\n    // save entity\n    const photoResult = await this.photoModel.save(photo);\n\n    // save success\n    console.log('photo id =', photoResult.id);\n  }\n}\n")),(0,a.kt)("h3",{id:"9-query-data"},"9. Query Data"),(0,a.kt)("p",null,"For more information, see ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/typeorm/typeorm/blob/master/docs/zh_CN/find-options.md"},"find documentation"),"."),(0,a.kt)("p",null,"The query API has changed since ",(0,a.kt)("a",{parentName:"p",href:"mailto:typeorm@0.3.0"},"typeorm@0.3.0"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},'import { Provide } from \'@midwayjs/core\';\nimport { InjectEntityModel } from \'@midwayjs/orm\';\nimport { Photo } from \'../entity/photo\';\nimport { Repository } from \'typeorm\';\n\n@Provide()\nexport class PhotoService {\n\n  @InjectEntityModel(Photo)\n  photoModel: Repository<Photo>;\n\n  // find\n  async findPhotos() {\n\n    // find All\n    let allPhotos = await this.photoModel.find(); // v0.2.x\n    let allPhotos = await this.photoModel.find({}); // v0.3.x\n    console.log("All photos from the db: ", allPhotos);\n\n    // find first\n    let firstPhoto = await this.photoModel.findOne(1);\n    let firstPhoto = await this.photoModel.findOne({ // v0.3.x\n      where: {\n        id: 1\n      }\n    });\n    console.log("First photo from the db: ", firstPhoto);\n\n    // find one by name\n    // v0.2.x\n    let meAndBearsPhoto = await this.photoModel.findOne({ name: "Me and Bears" });\n    // v0.3.x\n    let meAndBearsPhoto = await this.photoModel.findOne({\n      where: { name: "Me and Bears"}\n    });\n    console.log("Me and Bears photo from the db: ", meAndBearsPhoto);\n\n    // find by views\n    // v0.2.x\n    let allViewedPhotos = await this.photoModel.find({ views: 1 });\n    // v0.3.x\n    let allViewedPhotos = await this.photoModel.find({\n      where: { views: 1}\n    });\n    console.log("All viewed photos: ", allViewedPhotos);\n\n    // v0.2.x\n    let allViewedPhotos = await this.photoModel.find({ views: 1 });\n    // v0.3.x\n    let allPublishedPhotos = await this.photoModel.find({\n      where: { isPublished: true}\n    });\n    console.log("All published photos: ", allPublishedPhotos);\n\n    // find and get count\n    // v0.2.x\n    let [allPhotos, photosCount] = await this.photoModel.findAndCount();\n    // v0.3.x\n    let [allPhotos, photosCount] = await this.photoModel.findAndCount({});\n    console.log("All photos: ", allPhotos);\n    console.log("Photos count: ", photosCount);\n\n  }\n}\n\n')),(0,a.kt)("h3",{id:"10-update-the-database"},"10. Update the database"),(0,a.kt)("p",null,"Now, let's load a photo from the database, update it and save it."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Provide } from '@midwayjs/core';\nimport { InjectEntityModel } from '@midwayjs/orm';\nimport { Photo } from '../entity/photo';\nimport { Repository } from 'typeorm';\n\n@Provide()\nexport class PhotoService {\n\n  @InjectEntityModel(Photo)\n  photoModel: Repository<Photo>;\n\n  async updatePhoto() {\n\n    let photoToUpdate = await this.photoModel.findOne(1);\n    photoToUpdate.name = \"Me, my friends and polar bears\";\n\n    await this.photoModel.save(photoToUpdate);\n  }\n}\n")),(0,a.kt)("h3",{id:"11-delete-data"},"11. Delete data"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Provide } from '@midwayjs/core';\nimport { InjectEntityModel } from '@midwayjs/orm';\nimport { Photo } from '../entity/photo';\nimport { Repository } from 'typeorm';\n\n@Provide()\nexport class PhotoService {\n\n  @InjectEntityModel(Photo)\n  photoModel: Repository<Photo>;\n\n  async updatePhoto() {\n    /*...*/\n    let photoToRemove = await this.photoModel.findOne(1); // typeorm@0.2.x\n    await this.photoModel.remove(photoToRemove);\n  }\n}\n")),(0,a.kt)("p",null,"Now, Photo with ID = 1 will be deleted from the database."),(0,a.kt)("p",null,"There is also a soft deletion method."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"await this.photoModel.softDelete(1);\n")),(0,a.kt)("h3",{id:"12-create-a-one-to-one-association"},"12. Create a one-to-one association"),(0,a.kt)("p",null,"Let's create a one-to-one relationship with another class. Let's create a new class in ",(0,a.kt)("inlineCode",{parentName:"p"},"entity/photoMetadata.ts"),". This class contains additional meta-information for photo."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},'import { Column, PrimaryGeneratedColumn, OneToOne, JoinColumn } from \'typeorm\';\nimport { EntityModel } from \'@midwayjs/orm\';\nimport { Photo } from "./photo";\n\n@EntityModel()\nexport class PhotoMetadata {\n\n  @PrimaryGeneratedColumn()\n  id: number;\n\n  @Column("int")\n  height: number;\n\n  @Column("int")\n  width: number;\n\n  @Column()\n  orientation: string;\n\n  @Column()\n  compressed: boolean;\n\n  @Column()\n  comment: string;\n\n  @OneToOne(type => Photo)\n  @JoinColumn()\n  photo: Photo;\n\n}\n')),(0,a.kt)("p",null,"Here, we use a new fitting called ",(0,a.kt)("inlineCode",{parentName:"p"},"@OneToOne"),". It allows us to create a one-to-one relationship between two entities. ",(0,a.kt)("inlineCode",{parentName:"p"},"type => photo")," is a function that returns the class of the entity with which we want to establish a relationship."),(0,a.kt)("p",null,"Due to the particularity of the language, we are forced to use a function that returns the class instead of using the class directly. You can also write it as ",(0,a.kt)("inlineCode",{parentName:"p"},"() => Photo"),", but we use ",(0,a.kt)("inlineCode",{parentName:"p"},"type => Photo")," as a convention to improve the readability of the code. The type variable itself contains nothing."),(0,a.kt)("p",null,"We also added an ",(0,a.kt)("inlineCode",{parentName:"p"},"@JoinColumn")," decorator, which indicates that this side of the relationship will have the relationship. Relationships can be one-way or two-way. The relationship can only be owned by one party. The owner side of the relationship needs to use the @JoinColumn decorator.  If you run the application, you will see a newly generated table that will contain a column containing foreign keys for the Photo relationship."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"+-------------+--------------+----------------------------+\n|                     photo_metadata                      |\n+-------------+--------------+----------------------------+\n| id          | int(11)      | PRIMARY KEY AUTO_INCREMENT |\n| height      | int(11)      |                            |\n| width       | int(11)      |                            |\n| comment     | varchar(255) |                            |\n| compressed  | boolean      |                            |\n| orientation | varchar(255) |                            |\n| photoId     | int(11)      | FOREIGN KEY                |\n+-------------+--------------+----------------------------+\n")),(0,a.kt)("p",null,"Next we will associate them in the code."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},'import { Provide, Inject, Func } from \'@midwayjs/core\';\nimport { InjectEntityModel } from \'@midwayjs/orm\';\nimport { Photo } from \'./entity/photo\';\nimport { PhotoMetadata } from \'./entity/photoMetadata\';\nimport { Repository } from \'typeorm\';\n\n@Provide()\nexport class PhotoService {\n\n  @InjectEntityModel(Photo)\n  photoModel: Repository<Photo>;\n\n  @InjectEntityModel(PhotoMetadata)\n  photoMetadataModel: Repository<PhotoMetadata>;\n\n  async updatePhoto() {\n\n  // create a photo\n    let photo = new Photo();\n    photo.name = "Me and Bears";\n    photo.description = "I am near polar bears";\n    photo.filename = "photo-with-bears.jpg";\n    photo.isPublished = true;\n\n    // create a photo metadata\n    let metadata = new PhotoMetadata();\n    metadata.height = 640;\n    metadata.width = 480;\n    metadata.compressed = true;\n    metadata.comment = "cybershoot";\n    metadata.orientation = "portrait";\n    metadata.photo = photo; // this way we connect them\n\n\n    // first we should save a photo\n    await this.photoModel.save(photo);\n\n    // photo is saved. Now we need to save a photo metadata\n    await this.photoMetadataModel.save(metadata);\n\n    // done\n    console.log("Metadata is saved, and relation between metadata and photo is created in the database too");\n  }\n}\n')),(0,a.kt)("h3",{id:"13-reverse-relation-mapping"},"13. Reverse relation mapping"),(0,a.kt)("p",null,"Relational mapping can be one-way or two-way. When the relationship between PhotoMetadata and Photo is one-way. The owner of the relationship is PhotoMetadata, and Photo knows nothing about PhotoMetadata. This complicates accessing PhotoMetadata from the Photo side. To solve this problem, we add a reverse relational mapping to make the PhotoMetadata and Photo a two-way association. Let's modify our entity."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { EntityModel } from '@midwayjs/orm';\nimport { Column, PrimaryGeneratedColumn, OneToOne, JoinColumn } from 'typeorm';\nimport { Photo } from './photo';\n\n@EntityModel()\nexport class PhotoMetadata {\n\n  /* ... other columns */\n\n  @OneToOne(type => Photo, photo => photo.metadata)\n  @JoinColumn()\n  photo: Photo;\n}\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { EntityModel } from '@midwayjs/orm';\nimport { Entity, Column, PrimaryGeneratedColumn, OneToOne } from 'typeorm';\nimport { PhotoMetadata } from './photoMetadata';\n\n@EntityModel()\nexport class Photo {\n\n  /* ... other columns */\n\n  @OneToOne(type => PhotoMetadata, photoMetadata => photoMetadata.photo)\n  metadata: PhotoMetadata;\n}\n")),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"photo => photo.metadata")," is a function that returns a reverse mapping relationship. Here, we explicitly declare the metadata property of the Photo class to associate PhotoMetadata. In addition to passing functions that return the photo property, you can also pass strings directly to the ",(0,a.kt)("inlineCode",{parentName:"p"},"@OneToOne")," decorator, such as ",(0,a.kt)("inlineCode",{parentName:"p"},'"metadata"')," . But we use this method of function callback to make our code writing easier."),(0,a.kt)("p",null,"Note that the ",(0,a.kt)("inlineCode",{parentName:"p"},"@JoinColumn")," decorator will only be used on one side of the relationship map. No matter which side of this decorator you place, you are the owner of the relationship. The owner of the relationship contains columns with foreign keys in the database."),(0,a.kt)("h3",{id:"14-load-objects-and-their-dependencies"},"14. Load objects and their dependencies"),(0,a.kt)("p",null,"Now, let's try to load out Photo and PhotoMetadata together in a single query. There are two ways to do this, using the ",(0,a.kt)("inlineCode",{parentName:"p"},"find *")," method or using the ",(0,a.kt)("inlineCode",{parentName:"p"},"QueryBuilder")," function. Let's use the ",(0,a.kt)("inlineCode",{parentName:"p"},"find *")," method first. The ",(0,a.kt)("inlineCode",{parentName:"p"},"find*")," methods allow you to specify objects using the ",(0,a.kt)("inlineCode",{parentName:"p"},"FindOneOptions")," / ",(0,a.kt)("inlineCode",{parentName:"p"},"FindManyOptions")," interfaces."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Provide, Inject, Func } from '@midwayjs/core';\nimport { InjectEntityModel } from '@midwayjs/orm';\nimport { Photo } from './entity/photo';\nimport { Repository } from 'typeorm';\n\n@Provide()\nexport class PhotoService {\n\n  @InjectEntityModel(Photo)\n  photoModel: Repository<Photo>;\n\n  // find\n  async findPhoto() {\n        /*...*/\n    let photos = await this.photoModel.find({ relations: [ 'metadata' ] }); // typeorm@0.2.x\n  }\n}\n\n")),(0,a.kt)("p",null,"Here, the value of photos is an array containing the query results for the entire database, and each photo object contains its associated metadata property. Learn more about ",(0,a.kt)("inlineCode",{parentName:"p"},"Find Options")," in ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/typeorm/typeorm/blob/master/docs/find-options.md"},"this documentation"),"."),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"Find Options")," is simple, but if you need more complex queries, you should use ",(0,a.kt)("inlineCode",{parentName:"p"},"QueryBuilder")," instead.  ",(0,a.kt)("inlineCode",{parentName:"p"},"QueryBuilder")," allows more complex queries to be used in an elegant way."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Provide, Inject, Func } from '@midwayjs/core';\nimport { InjectEntityModel } from '@midwayjs/orm';\nimport { Photo } from './entity/photo';\nimport { Repository } from 'typeorm';\n\n@Provide()\nexport class PhotoService {\n\n  @InjectEntityModel(Photo)\n  photoModel: Repository<Photo>;\n\n  // find\n  async findPhoto() {\n        /*...*/\n    let photos = await this.photoModel\n            .createQueryBuilder('photo')\n            .innerJoinAndSelect('photo.metadata', 'metadata')\n            .getMany();\n  }\n}\n")),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"QueryBuilder")," allows the creation and execution of almost any complex SQL query. When using ",(0,a.kt)("inlineCode",{parentName:"p"},"QueryBuilder"),', think like creating SQL queries. In this example, "photo" and "metadata" are aliases applied to the selected photos. You can use aliases to access the columns and properties of the selected data.'),(0,a.kt)("h3",{id:"15-use-cascade-operations-to-automatically-save-associated-objects"},"15. Use cascade operations to automatically save associated objects"),(0,a.kt)("p",null,"Cascade can be set in the relationship when we want to automatically save the associated object every time we save another object. Let's slightly change the ",(0,a.kt)("inlineCode",{parentName:"p"},"@OneToOne")," decorator of the photo."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"export class Photo {\n  /// ... other columns\n\n  @OneToOne(type => PhotoMetadata, metadata => metadata.photo, {\n    cascade: true,\n  })\n  metadata: PhotoMetadata;\n}\n")),(0,a.kt)("p",null,"Using ",(0,a.kt)("inlineCode",{parentName:"p"},"cascade")," allows us to no longer save Photo and PhotoMetadata separately now. Due to the cascade option, metadata objects will be saved automatically."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},'import { Provide, Inject, Func } from \'@midwayjs/core\';\nimport { InjectEntityModel } from \'@midwayjs/orm\';\nimport { Photo } from \'./entity/photo\';\nimport { PhotoMetadata } from \'./entity/photoMetadata\';\nimport { Repository } from \'typeorm\';\n\n@Provide()\nexport class PhotoService {\n\n  @InjectEntityModel(Photo)\n  photoModel: Repository<Photo>;\n\n  async updatePhoto() {\n\n   // create photo object\n    let photo = new Photo();\n    photo.name = "Me and Bears";\n    photo.description = "I am near polar bears";\n    photo.filename = "photo-with-bears.jpg";\n    photo.isPublished = true;\n\n    // create photo metadata object\n    let metadata = new PhotoMetadata();\n    metadata.height = 640;\n    metadata.width = 480;\n    metadata.compressed = true;\n    metadata.comment = "cybershoot";\n    metadata.orientation = "portrait";\n\n    photo.metadata = metadata; // this way we connect them\n\n    // save a photo also save the metadata\n    await this.photoModel.save(photo);\n\n    // done\n    console.log("Photo is saved, photo metadata is saved too");\n  }\n}\n')),(0,a.kt)("p",null,"Note that we now set the metadata of Photo instead of setting the Photo attribute of metadata as before. This is only valid when you connect Photo to the PhotoMetadata from the Photo side. If set on the PhotoMetadata side, it will not be saved automatically."),(0,a.kt)("h3",{id:"16-create-many-to-oneone-to-many-associations"},"16. Create many-to-one/one-to-many associations"),(0,a.kt)("p",null,"Let's create a many-to-one/one-to-many relationship. Suppose a photo has an author, and each author can have many photos. First, let's create an Author class:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { EntityModel } from '@midwayjs/orm';\nimport { Column, PrimaryGeneratedColumn, OneToMany, JoinColumn } from \"typeorm\";\nimport { Photo } from './entity/photo';\n\n@EntityModel()\nexport class Author {\n\n  @PrimaryGeneratedColumn()\n  id: number;\n\n  @Column()\n  name: string;\n\n  @OneToMany(type => Photo, photo => photo.author) // note: we will create author property in the Photo class below\n  photos: Photo[];\n}\n")),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"Author")," contains a reverse relationship.  ",(0,a.kt)("inlineCode",{parentName:"p"},"OneToMany")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"ManyToOne")," need to appear in pairs."),(0,a.kt)("p",null,"Now, add the owner of the relationship to the Photo entity:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},'import { EntityModel } from \'@midwayjs/orm\';\nimport { Column, PrimaryGeneratedColumn, ManyToOne } from "typeorm";\nimport { PhotoMetadata } from "./photoMetadata";\nimport { Author } from "./author";\n\n@Entity()\nexport class Photo {\n\n  /* ... other columns */\n\n  @ManyToOne(type => Author, author => author.photos)\n  author: Author;\n}\n')),(0,a.kt)("p",null,"In a many-to-one/one-to-many relationship, the owner is always many-to-one. This means that the class using the ",(0,a.kt)("inlineCode",{parentName:"p"},"@ManyToOne")," will store the ID of the related object."),(0,a.kt)("p",null,"After the application is run, ORM creates the ",(0,a.kt)("inlineCode",{parentName:"p"},"author")," table:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"+-------------+--------------+----------------------------+\n|                          author                         |\n+-------------+--------------+----------------------------+\n| id          | int(11)      | PRIMARY KEY AUTO_INCREMENT |\n| name        | varchar(255) |                            |\n+-------------+--------------+----------------------------+\n")),(0,a.kt)("p",null,"It also modifies the ",(0,a.kt)("inlineCode",{parentName:"p"},"photo")," table, adds a new ",(0,a.kt)("inlineCode",{parentName:"p"},"author")," column, and creates a foreign key for it:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"+-------------+--------------+----------------------------+\n|                         photo                           |\n+-------------+--------------+----------------------------+\n| id          | int(11)      | PRIMARY KEY AUTO_INCREMENT |\n| name        | varchar(255) |                            |\n| description | varchar(255) |                            |\n| filename    | varchar(255) |                            |\n| isPublished | boolean      |                            |\n| authorId    | int(11)      | FOREIGN KEY                |\n+-------------+--------------+----------------------------+\n")),(0,a.kt)("h3",{id:"17-create-many-to-many-associations"},"17. Create many-to-many associations"),(0,a.kt)("p",null,"Let's create a many-to-one/many-to-many relationship. Suppose a photo can be in many albums, and each album can contain many photos. Let's create an ",(0,a.kt)("inlineCode",{parentName:"p"},"Album")," class."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { EntityModel } from '@midwayjs/orm';\nimport { PrimaryGeneratedColumn, Column, ManyToMany, JoinTable } from \"typeorm\";\n\n@EntityModel()\nexport class Album {\n\n  @PrimaryGeneratedColumn()\n  id: number;\n\n  @Column()\n  name: string;\n\n  @ManyToMany(type => Photo, photo => photo.albums)\n  @JoinTable()\n  photos: Photo[];\n}\n")),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"@JoinTable")," is used to indicate that this is the owner of the relationship."),(0,a.kt)("p",null,"Now, add the reverse association to ",(0,a.kt)("inlineCode",{parentName:"p"},"Photo"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"export class Photo {\n  /// ... other columns\n\n  @ManyToMany(type => Album, album => album.photos)\n  albums: Album[];\n}\n")),(0,a.kt)("p",null,"After running the application, ORM will create a album_photos_photo_albums join table:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"+-------------+--------------+----------------------------+\n|                album_photos_photo_albums                |\n+-------------+--------------+----------------------------+\n| album_id    | int(11)      | PRIMARY KEY FOREIGN KEY    |\n| photo_id    | int(11)      | PRIMARY KEY FOREIGN KEY    |\n+-------------+--------------+----------------------------+\n")),(0,a.kt)("p",null,"Now, let's insert albums and photos into the database:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},'import { Provide, Inject, Func } from \'@midwayjs/core\';\nimport { InjectEntityModel } from \'@midwayjs/orm\';\nimport { Photo } from \'./entity/photo\';\nimport { PhotoMetadata } from \'./entity/photoMetadata\';\nimport { Repository } from \'typeorm\';\n\n@Provide()\nexport class PhotoService {\n\n  @InjectEntityModel(Photo)\n  photoModel: Repository<Photo>;\n\n  @InjectEntityModel(Album)\n  albumModel: Repository<Album>\n\n  async updatePhoto() {\n\n    // create a few albums\n    let album1 = new Album();\n    album1.name = "Bears";\n    await this.albumModel.save(album1);\n\n    let album2 = new Album();\n    album2.name = "Me";\n    await this.albumModel.save(album2);\n\n    // create a few photos\n    let photo = new Photo();\n    photo.name = "Me and Bears";\n    photo.description = "I am near polar bears";\n    photo.filename = "photo-with-bears.jpg";\n    photo.albums = [album1, album2];\n    await this.photoModel.save(photo);\n\n\n    // now our photo is saved and albums are attached to it\n    // now lets load them:\n    const loadedPhoto = await this.photoModel.findOne(1, { relations: ["albums"] }); // typeorm@0.2.x\n  }\n}\n')),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"loadedPhoto")," value is:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'{\n  id: 1\n  name: "Me and Bears ",\n  description: "I am near polar bears ",\n  filename: "photo-with-bears.jpg ",\n  albums: [{\n    id: 1\n    name: "Bears"\n  }, {\n    id: 2\n    name: "Me"\n  }]\n}\n')),(0,a.kt)("h3",{id:"18-use-querybuilder"},"18. Use QueryBuilder"),(0,a.kt)("p",null,"You can use QueryBuilder to build almost any complex SQL query. For example, you can do this:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},'let photos = await this.photoModel\n    .createQueryBuilder("photo") // first argument is an alias. Alias is what you are selecting - photos. You must specify it.\n    .innerJoinAndSelect("photo.metadata", "metadata")\n    .leftJoinAndSelect("photo.albums", "album")\n    .where("photo.isPublished = true")\n    .andWhere("(photo.name = :photoName OR photo.name = :bearName)")\n    .orderBy("photo.id", "DESC")\n    .skip(5)\n    .take(10)\n    .setParameters({ photoName: "My", bearName: "Mishka" })\n    .getMany();\n')),(0,a.kt)("p",null,'The query selects all published photos with "My" or "Mishka" names. It will return results (paging offset) from position 5, and only 10 results (paging limit) will be selected. The selection results will be sorted in descending order of ID. The photo album will be left-Joined and metadata will be automatically associated.'),(0,a.kt)("p",null,"You will use query generators extensively in your application. Learn more about QueryBuilder ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/typeorm/typeorm/blob/master/docs/zh_CN/select-query-builder.md"},"here"),"."),(0,a.kt)("h3",{id:"19-event-subscriber"},"19. Event Subscriber"),(0,a.kt)("p",null,"typeorm provides an event subscription mechanism to facilitate log output when doing some database operations. For this reason, midway provides a ",(0,a.kt)("inlineCode",{parentName:"p"},"EventSubscriberModel")," decorator to label event subscription classes with the following code."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Provide } from '@midwayjs/core';\nimport { EventSubscriberModel } from '@midwayjs/orm';\nimport { EntitySubscriberInterface, InsertEvent, UpdateEvent, RemoveEvent } from 'typeorm';\n\n@Provide()\n@EventSubscriberModel()\nexport class EverythingSubscriber implements EntitySubscriberInterface {\n\n  /**\n   * Called before entity insertion.\n   */\n  beforeInsert(event: InsertEvent<any>) {\n    console.log('BEFORE ENTITY INSERTED:', event.entity);\n  }\n\n  /**\n   * Called before entity insertion.\n   */\n  beforeUpdate(event: UpdateEvent<any>) {\n    console.log('BEFORE ENTITY UPDATED:', event.entity);\n  }\n\n  /**\n   * Called before entity insertion.\n   */\n  beforeRemove(event: RemoveEvent<any>) {\n    console.log('BEFORE ENTITY WITH ID ${event.entityId} REMOVED:', event.entity);\n  }\n\n  /**\n   * Called after entity insertion.\n   */\n  afterInsert(event: InsertEvent<any>) {\n    console.log('AFTER ENTITY INSERTED:', event.entity);\n  }\n\n  /**\n     * Called after entity insertion.\n     */\n  afterUpdate(event: UpdateEvent<any>) {\n    console.log('AFTER ENTITY UPDATED:', event.entity);\n  }\n\n  /**\n   * Called after entity insertion.\n   */\n  afterRemove(event: RemoveEvent<any>) {\n    console.log('AFTER ENTITY WITH ID ${event.entityId} REMOVED:', event.entity);\n  }\n\n  /**\n   * Called after entity is loaded.\n   */\n  afterLoad(entity: any) {\n    console.log('AFTER ENTITY LOADED:', entity);\n  }\n\n}\n")),(0,a.kt)("p",null,"This subscription class provides some common interfaces to perform some things during database operations."),(0,a.kt)("h3",{id:"20-ormconnectionhook"},"20. OrmConnectionHook"),(0,a.kt)("p",null,"In versions prior to 3.4.0 (not included), the Midway package provided a Hook mechanism for monitoring database connection and disconnection events; the code is as follows."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Provide } from '@midwayjs/core';\nimport { OrmConnectionHook, OrmHook } from '@midwayjs/orm';\nimport { Connection, ConnectionOptions } from 'typeorm';\n\n@Provide()\n@OrmHook()\nexport class OrmConnectionListener implements OrmConnectionHook {\n  /**\n   * Called before connection create\n   * @param opts\n   * @returns\n   */\n  async beforeCreate(opts?: ConnectionOptions): Promise<ConnectionOptions> {\n    console.log('BEFORE CONNECTION CREATE');\n    return opts;\n  }\n\n  /**\n   * Called after connection create\n   * @param conn\n   * @param opts\n   * @returns\n   */\n  async afterCreate(conn?: Connection, opts?: ConnectionOptions): Promise<Connection> {\n    console.log('AFTER CONNECTION CREATE');\n    return conn;\n  }\n\n  /**\n   * Called before connection close\n   * @param conn\n   * @param connectionName\n   * @returns\n   */\n  async beforeClose(conn?: Connection, connectionName?: string): Promise<Connection> {\n    console.log('BEFORE CONNECTION CLOSE');\n    return conn;\n  }\n\n  /**\n   * Called after connection close\n   * @param conn\n   * @returns\n   */\n  async afterClose(conn?: Connection): Promise<Connection> {\n    console.log('AFTER CONNECTION CLOSE');\n    return conn;\n  }\n}\n")),(0,a.kt)("h2",{id:"advanced-features"},"Advanced features"),(0,a.kt)("h3",{id:"multi-database-support"},"Multi-database support"),(0,a.kt)("p",null,"Sometimes, we have multiple database connections (Connection) in an application, and there will be multiple configurations at this time. We use the ",(0,a.kt)("strong",{parentName:"p"},"object form")," to define the configuration."),(0,a.kt)("p",null,"For example, the following defines two database connections (Connection), ",(0,a.kt)("inlineCode",{parentName:"p"},"default")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"test"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import {join} from 'path';\n\nexport default {\n  orm: {\n    default: {\n      type: 'sqlite',\n      database: join(__dirname, '../../default.sqlite')\n      logging: true\n    },\n    test: {\n      type: 'mysql',\n      host: '127.0.0.1',\n      port: 3306\n      username: '*********',\n      password: '*********',\n      database: undefined\n      synchronize: true\n      logging: false\n    }\n  }\n}\n")),(0,a.kt)("p",null,"In use, you need to specify which connection (Connection) the model belongs."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// entity/photo.ts\nimport { InjectEntityModel } from '@midwayjs/orm';\nimport { User } from './model/user';\n\nexport class XXX {\n\n  @InjectEntityModel(User, 'test')\n  testUserModel: Repository<User>;\n\n  //...\n}\n")),(0,a.kt)("p",null,"Similarly, when using the injection Model, you need to specify the connection."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// entity/photo.ts\nimport { EntityModel } from '@midwayjs/orm';\n\n@EntityModel('photo', {\n    connectionName: 'test'\n})\nexport class Photo {\n  id: number;\n  name: string;\n  description: string;\n  filename: string;\n  views: number;\n  isPublished: boolean;\n}\n")),(0,a.kt)("h3",{id:"get-connection-pool"},"Get connection pool"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Configuration } from '@midwayjs/core';\nimport { getConnection } from 'typeorm';\n\n@Configuration()\nexport class MainConfiguration {\n  async onReady() {\n    const conn = getConnection('default');\n    console.log(conn.isConnected);\n  }\n}\n")),(0,a.kt)("h3",{id:"hooks-scenario-support"},"Hooks scenario support"),(0,a.kt)("p",null,"For the scenario of functional programming, we provide a simplified functional writing."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"import { useEntityModel } from '@midwayjs/orm';\nimport { Photo } from './entity/photo';\n\nexport async function getPhoto() {\n  // get model\n  const photoModel = useEntityModel(Photo);\n\n  const photo = new Photo();\n  // create entity\n  photo.name = \"Me and Bears\";\n  photo.description = \"I am near polar bears\";\n  photo.filename = \"photo-with-bears.jpg\";\n  photo.views = 1;\n  photo.isPublished = true;\n\n  // find\n  const newPhoto = await photoModel.save(photo);\n\n  return 'hello world';\n}\n")),(0,a.kt)("h3",{id:"about-table-structure-synchronization"},"About Table Structure Synchronization"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"If you already have a table structure, you want to automatically create an Entity and use the ",(0,a.kt)("a",{parentName:"li",href:"../tool/typeorm_generator"},"Generator")),(0,a.kt)("li",{parentName:"ul"},"If you already have Entity code, use the ",(0,a.kt)("inlineCode",{parentName:"li"},"synchronize: true")," in the configuration to create a table structure.")),(0,a.kt)("h2",{id:"frequently-asked-questions"},"Frequently Asked Questions"),(0,a.kt)("h3",{id:"handshake-inactivity-timeout"},"Handshake inactivity timeout"),(0,a.kt)("p",null,"Generally, it is due to network reasons. If it appears locally, you can ping but telnet is not available. You can try to execute the following command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"$sudo sysctl -w net.inet.tcp.sack=0\n")),(0,a.kt)("h3",{id:"about-the-current-time-zone-display-of-mysql-time-column"},"About the current time zone display of mysql time column"),(0,a.kt)("p",null,"If you use the ",(0,a.kt)("inlineCode",{parentName:"p"},"@UpdateDateColumn")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"@CreateDateColumn")," columns, UTC time is normally saved in the database. If you want to return the time in the current time zone, you can use the following method."),(0,a.kt)("p",null,"When configuring, turn on the time-to-string option."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default.ts\nexport default {\n  // ...\n  orm: {\n    //...\n    dateStrings: true\n  },\n}\n")),(0,a.kt)("p",null,"The time column in the entity requires a column type."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"@EntityModel()\nexport class Photo {\n  //...\n  @UpdateDateColumn({\n    name: \"gmt_modified \",\n    type: 'timestamp'\n  })\n  gmtModified: Date;\n\n  @CreateDateColumn({\n    name: \"gmt_create \",\n    type: 'timestamp'\n  })\n  gmtCreate: Date;\n}\n")),(0,a.kt)("p",null,"In this way, the output time field is the current time zone."),(0,a.kt)("p",null,"The effect is as follows:"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Before configuring:")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"gmtModified: 2021-12-13T03:49:43.000Z\ngmtCreate: 2021-12-13T03:49:43.000Z\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"After configuration:")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"gmtModified: '2021-12-13 11:49:43',\ngmtCreate: '2021-12-13 11:49:43'\n")),(0,a.kt)("h3",{id:"default-values-for-time-columns"},"Default values for time columns"),(0,a.kt)("p",null,"If the ",(0,a.kt)("inlineCode",{parentName:"p"},"@UpdateDateColumn")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"@CreateDateColumn")," columns are used, note that the default value is typeorm automatically added to the table-building statement. if the table is self-built, the field will be written to 00:00:00 because there is no default value."),(0,a.kt)("p",null,"There are two solutions: ",(0,a.kt)("strong",{parentName:"p"},"1. Modify the default value of a table")," or ",(0,a.kt)("strong",{parentName:"p"},"2. Modify the default value of a column in the code")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"If you don't want to modify the table, but want to modify the code, please refer to the code below. ")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"@Column({\n  default: () => \"NOW() \",\n  type: 'timestamp'\n})\ncreatedOn: Date;\n\n@Column({\n  default: () => \"NOW() \",\n  type: 'timestamp'\n})\nmodifiedOn: Date;\n")),(0,a.kt)("h3",{id:"install-mysql-and-mysql2-at-the-same-time"},"Install mysql and mysql2 at the same time"),(0,a.kt)("p",null,"when both mysql and mysql2 are present in the node_modules, the typeorm automatically loads mysql instead of mysql2."),(0,a.kt)("p",null,"If you need to use mysql2 at this time, please specify driver."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"// src/config/config.default.ts\nexport default {\n  // ...\n  orm: {\n    //...\n    type: 'mysql',\n    driver: require('mysql2')\n  },\n}\n")))}c.isMDXComponent=!0}}]);